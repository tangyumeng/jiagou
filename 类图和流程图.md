# 类图和流程图

## 一、类图 (Class Diagram)

### 完整类图

```
┌─────────────────────────────────────┐
│         DownloadState               │
│         <<enumeration>>             │
├─────────────────────────────────────┤
│ + waiting                           │
│ + downloading                       │
│ + paused                            │
│ + completed                         │
│ + failed                            │
│ + cancelled                         │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│         DownloadTask                │
├─────────────────────────────────────┤
│ - id: String                        │
│ - url: URL                          │
│ - fileName: String                  │
│ - state: DownloadState              │
│ - progress: Double                  │
│ - totalBytes: Int64                 │
│ - downloadedBytes: Int64            │
│ - speed: Double                     │
│ - error: Error?                     │
│ - destinationPath: URL?             │
│ - downloadTask: URLSessionDownloadTask? │
│ - resumeData: Data?                 │
│ - onProgressChanged: ((DownloadTask) -> Void)? │
│ - onStateChanged: ((DownloadTask) -> Void)?    │
├─────────────────────────────────────┤
│ + init(url: URL, fileName: String?) │
│ + updateProgress(downloadedBytes:totalBytes:) │
│ + formattedFileSize() -> String     │
│ + formattedSpeed() -> String        │
│ + stateDescription() -> String      │
│ - notifyProgressChanged()           │
│ - notifyStateChanged()              │
└─────────────────────────────────────┘
              ▲
              │ 使用
              │
┌─────────────────────────────────────┐
│    DownloadManagerDelegate          │
│         <<protocol>>                │
├─────────────────────────────────────┤
│ + downloadManager(_:didUpdateTask:) │
│ + downloadManager(_:didCompleteTask:)│
│ + downloadManager(_:didFailTask:withError:) │
└─────────────────────────────────────┘
              ▲
              │ 实现
              │
┌─────────────────────────────────────┐
│       DownloadManager               │
├─────────────────────────────────────┤
│ + shared: DownloadManager           │
│ - session: URLSession               │
│ - tasks: [String: DownloadTask]     │
│ - maxConcurrentDownloads: Int       │
│ - activeDownloadCount: Int          │
│ - taskQueue: DispatchQueue          │
│ - downloadDirectory: URL            │
│ + delegate: DownloadManagerDelegate? │
├─────────────────────────────────────┤
│ + addTask(url:fileName:) -> DownloadTask │
│ + getAllTasks() -> [DownloadTask]   │
│ + getTask(byId:) -> DownloadTask?   │
│ + startDownload(taskId:)            │
│ + pauseDownload(taskId:)            │
│ + cancelDownload(taskId:)           │
│ + removeTask(taskId:)               │
│ + clearCompletedTasks()             │
│ - startTask(_:)                     │
│ - resumeTask(_:)                    │
│ - startNextTaskIfPossible()         │
│ - findTask(for:) -> DownloadTask?   │
└─────────────────────────────────────┘
              │ 管理
              ▼
     [DownloadTask集合]
              ▲
              │
              │ 展示
┌─────────────────────────────────────┐
│       ViewController                │
├─────────────────────────────────────┤
│ - tableView: UITableView            │
│ - downloadManager: DownloadManager  │
│ - tasks: [DownloadTask]             │
│ - testURLs: [String]                │
├─────────────────────────────────────┤
│ + viewDidLoad()                     │
│ - setupUI()                         │
│ - setupDownloadManager()            │
│ - loadTasks()                       │
│ - setupTaskObservers(_:)            │
│ - updateTaskCell(_:)                │
│ - addDownloadTask()                 │
│ - createDownloadTask(urlString:)    │
│ - clearCompleted()                  │
│ - handleTaskAction(_:)              │
└─────────────────────────────────────┘
              │ 使用
              ▼
┌─────────────────────────────────────┐
│      DownloadTaskCell               │
├─────────────────────────────────────┤
│ - fileNameLabel: UILabel            │
│ - statusLabel: UILabel              │
│ - progressView: UIProgressView      │
│ - percentLabel: UILabel             │
│ - speedLabel: UILabel               │
│ - actionButton: UIButton            │
│ + task: DownloadTask?               │
│ + actionHandler: ((DownloadTask, DownloadTaskCell) -> Void)? │
├─────────────────────────────────────┤
│ - setupUI()                         │
│ - updateUI()                        │
│ - actionButtonTapped()              │
└─────────────────────────────────────┘
```

### 关系说明

1. **DownloadTask** 使用 **DownloadState** 枚举来表示状态
2. **DownloadManager** 管理多个 **DownloadTask** 对象
3. **ViewController** 实现 **DownloadManagerDelegate** 协议
4. **ViewController** 使用 **DownloadManager** 单例
5. **ViewController** 通过 TableView 展示 **DownloadTaskCell**
6. **DownloadTaskCell** 显示单个 **DownloadTask** 的信息

---

## 二、时序图 (Sequence Diagram)

### 2.1 添加并开始下载任务

```
用户           ViewController    DownloadManager      DownloadTask    URLSession
 │                  │                   │                   │              │
 │ 点击添加按钮      │                   │                   │              │
 ├─────────────────>│                   │                   │              │
 │                  │ addTask()         │                   │              │
 │                  ├──────────────────>│                   │              │
 │                  │                   │ 创建DownloadTask  │              │
 │                  │                   ├──────────────────>│              │
 │                  │                   │                   │              │
 │                  │                   │ 存储到tasks字典    │              │
 │                  │                   │                   │              │
 │                  │<──返回task────────│                   │              │
 │                  │                   │                   │              │
 │                  │ setupObservers()  │                   │              │
 │                  │                   │                   │              │
 │                  │ startDownload()   │                   │              │
 │                  ├──────────────────>│                   │              │
 │                  │                   │ startTask()       │              │
 │                  │                   │                   │              │
 │                  │                   │ 创建downloadTask  │              │
 │                  │                   ├─────────────────────────────────>│
 │                  │                   │                   │  resume()    │
 │                  │                   │                   │              │
 │                  │                   │ 更新state为downloading          │
 │                  │                   │                   │              │
 │<─────UI更新──────│<──onStateChanged──│<──通知────────────│              │
 │                  │                   │                   │              │
```

### 2.2 下载进度更新流程

```
URLSession     DownloadManager    DownloadTask    ViewController   Cell
    │                │                 │                │           │
    │ didWriteData   │                 │                │           │
    ├───────────────>│                 │                │           │
    │                │ findTask()      │                │           │
    │                │                 │                │           │
    │                │ updateProgress()│                │           │
    │                ├────────────────>│                │           │
    │                │                 │ 计算进度和速度  │           │
    │                │                 │                │           │
    │                │                 │ notifyProgressChanged()    │
    │                │                 ├───────────────>│           │
    │                │                 │ onProgressChanged()        │
    │                │                 │                │           │
    │                │ didUpdateTask() │                │           │
    │                ├─────────────────────────────────>│           │
    │                │                 │                │ updateUI()│
    │                │                 │                ├──────────>│
    │                │                 │                │           │
```

### 2.3 暂停下载流程

```
用户          Cell      ViewController   DownloadManager   DownloadTask   URLSession
 │             │              │                │                │             │
 │ 点击暂停     │              │                │                │             │
 ├────────────>│              │                │                │             │
 │             │ actionHandler()               │                │             │
 │             ├─────────────>│                │                │             │
 │             │              │ handleTaskAction()             │             │
 │             │              │                │                │             │
 │             │              │ pauseDownload()│                │             │
 │             │              ├───────────────>│                │             │
 │             │              │                │ cancel(byProducingResumeData:)│
 │             │              │                ├───────────────────────────────>│
 │             │              │                │                │             │
 │             │              │                │<──resumeData───│             │
 │             │              │                │ 保存resumeData │             │
 │             │              │                │ state=paused   │             │
 │             │              │                │                │             │
 │             │              │                │ activeDownloadCount--        │
 │             │              │                │ startNextTaskIfPossible()    │
 │             │              │                │                │             │
 │             │<────UI更新───│<──onStateChanged()─────────────│             │
 │             │              │                │                │             │
```

### 2.4 继续下载流程

```
用户          Cell      ViewController   DownloadManager   DownloadTask   URLSession
 │             │              │                │                │             │
 │ 点击继续     │              │                │                │             │
 ├────────────>│              │                │                │             │
 │             │ actionHandler()               │                │             │
 │             ├─────────────>│                │                │             │
 │             │              │ startDownload()│                │             │
 │             │              ├───────────────>│                │             │
 │             │              │                │ resumeTask()   │             │
 │             │              │                │                │             │
 │             │              │                │ 检查resumeData │             │
 │             │              │                │                │             │
 │             │              │                │ downloadTask(withResumeData:)│
 │             │              │                ├───────────────────────────────>│
 │             │              │                │                │  resume()   │
 │             │              │                │ state=downloading            │
 │             │              │                │ activeDownloadCount++        │
 │             │              │                │                │             │
 │             │<────UI更新───│<──onStateChanged()─────────────│             │
 │             │              │                │                │             │
```

### 2.5 下载完成流程

```
URLSession     DownloadManager    DownloadTask    ViewController
    │                │                 │                │
    │ didFinishDownloadingTo           │                │
    ├───────────────>│                 │                │
    │                │ findTask()      │                │
    │                │                 │                │
    │                │ 移动文件到目标位置│                │
    │                │                 │                │
    │                │ state=completed │                │
    │                ├────────────────>│                │
    │                │                 │                │
    │                │ activeDownloadCount--            │
    │                │ startNextTaskIfPossible()        │
    │                │                 │                │
    │                │ didCompleteTask()│               │
    │                ├─────────────────────────────────>│
    │                │                 │                │
    │                │                 │         显示完成提示
    │                │                 │                │
    │                │                 │ onStateChanged()│
    │                │                 ├───────────────>│
    │                │                 │                │
```

---

## 三、状态转换图

```
                    ┌──────────────┐
                    │   创建任务    │
                    └──────┬───────┘
                           │
                           ▼
                    ┌──────────────┐
              ┌────>│   waiting    │
              │     │   (等待中)    │
              │     └──────┬───────┘
              │            │
              │            │ startTask()
              │            │
              │            ▼
┌─────────────┴────┐ ┌──────────────┐
│     paused       │ │ downloading  │
│    (已暂停)       │<┤  (下载中)    │
└─────────┬────────┘ └──────┬───────┘
          │                  │
          │                  │ pauseDownload()
          │                  │
          │ startDownload()  │
          │                  │
          └──────────────────┘
                    │
                    │ 完成 / 失败 / 取消
                    │
          ┌─────────┴─────────┬──────────────┐
          ▼                   ▼              ▼
   ┌────────────┐      ┌────────────┐ ┌────────────┐
   │ completed  │      │   failed   │ │ cancelled  │
   │  (已完成)   │      │   (失败)    │ │  (已取消)   │
   └────────────┘      └─────┬──────┘ └─────┬──────┘
                             │              │
                             │ retry        │ restart
                             │              │
                             └──────┬───────┘
                                    │
                                    ▼
                             ┌──────────────┐
                             │   waiting    │
                             └──────────────┘
```

---

## 四、并发控制流程

```
任务队列管理

┌─────────────────────────────────────────────────────┐
│                   任务总览                           │
├─────────────────────────────────────────────────────┤
│                                                     │
│  活跃下载区 (maxConcurrentDownloads = 3)            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │ Task 1   │  │ Task 2   │  │ Task 3   │         │
│  │ ████░░░  │  │ ███░░░░  │  │ █░░░░░░  │         │
│  │ 45%      │  │ 32%      │  │ 12%      │         │
│  └──────────┘  └──────────┘  └──────────┘         │
│       ▲             ▲             ▲                │
│       └─────────────┴─────────────┘                │
│              activeDownloadCount = 3               │
│                                                     │
│  ─────────────────────────────────────────────     │
│                                                     │
│  等待队列 (FIFO)                                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │ Task 4   │  │ Task 5   │  │ Task 6   │         │
│  │ waiting  │  │ waiting  │  │ waiting  │         │
│  └──────────┘  └──────────┘  └──────────┘         │
│                                                     │
└─────────────────────────────────────────────────────┘

当任何一个活跃任务完成/暂停/取消时：
1. activeDownloadCount--
2. 调用 startNextTaskIfPossible()
3. 从等待队列取出第一个任务
4. 启动该任务，activeDownloadCount++
```

### 并发控制伪代码

```swift
func startDownload(taskId: String) {
    guard let task = getTask(byId: taskId) else { return }
    
    if activeDownloadCount < maxConcurrentDownloads {
        // 有空闲槽位，直接开始
        startTask(task)
        activeDownloadCount++
    } else {
        // 没有空闲槽位，进入等待队列
        task.state = .waiting
    }
}

func taskDidFinish(task: DownloadTask) {
    activeDownloadCount--
    startNextTaskIfPossible()
}

func startNextTaskIfPossible() {
    if activeDownloadCount < maxConcurrentDownloads {
        if let waitingTask = tasks.values.first(where: { $0.state == .waiting }) {
            startTask(waitingTask)
            activeDownloadCount++
        }
    }
}
```

---

## 五、数据流图

```
                    用户交互
                       │
                       ▼
              ┌────────────────┐
              │ ViewController │
              └────────┬───────┘
                       │
         ┌─────────────┴─────────────┐
         │                           │
         ▼                           ▼
  ┌──────────────┐          ┌──────────────┐
  │ UI事件处理    │          │  代理回调     │
  │ - 添加任务    │          │ - 下载完成    │
  │ - 暂停/继续   │          │ - 下载失败    │
  │ - 删除任务    │          │ - 进度更新    │
  └──────┬───────┘          └──────▲───────┘
         │                         │
         ▼                         │
  ┌──────────────────────────────────────┐
  │        DownloadManager               │
  │  ┌──────────────────────────────┐   │
  │  │     任务管理                  │   │
  │  │  tasks: [String: DownloadTask]│   │
  │  └──────────────────────────────┘   │
  │  ┌──────────────────────────────┐   │
  │  │     并发控制                  │   │
  │  │  activeDownloadCount          │   │
  │  │  maxConcurrentDownloads       │   │
  │  └──────────────────────────────┘   │
  │  ┌──────────────────────────────┐   │
  │  │    线程安全                   │   │
  │  │  taskQueue: DispatchQueue     │   │
  │  └──────────────────────────────┘   │
  └───────────┬──────────────────────────┘
              │
              ▼
  ┌─────────────────────────┐
  │    URLSession           │
  │  - Background配置        │
  │  - Delegate回调          │
  │  - 实际下载操作          │
  └──────────┬──────────────┘
             │
             ▼
  ┌─────────────────────────┐
  │    本地文件系统          │
  │  Documents/Downloads/    │
  └─────────────────────────┘
```

---

## 六、内存管理图

```
┌──────────────────────────────────────────┐
│          DownloadManager                 │
│          (单例，应用生命周期)              │
└──────────────┬───────────────────────────┘
               │ 强引用
               ▼
        ┌──────────────┐
        │ tasks: [...]  │
        └──────┬───────┘
               │ 强引用
               ▼
   ┌──────────────────────┐
   │   DownloadTask       │
   └──────┬───────────────┘
          │ weak引用（闭包中）
          │
          ▼
   ┌──────────────────────┐
   │   ViewController     │
   └──────────────────────┘
          ▲
          │ weak引用
          │
   ┌──────┴───────────────┐
   │ DownloadManager      │
   │ delegate: weak       │
   └──────────────────────┘

关键点：
1. DownloadTask 的闭包使用 [weak self]
2. ViewController 是 delegate 的 weak 引用
3. 避免循环引用
```

---

## 七、关键流程总结

### 1. 任务生命周期
```
创建 → 等待 → 下载中 → 完成
            ↓      ↑
            暂停 ───┘
            ↓
      失败/取消 → 重试 → 等待
```

### 2. 并发控制策略
```
1. 检查活跃任务数
2. 如果 < maxConcurrentDownloads，立即开始
3. 如果 >= maxConcurrentDownloads，进入等待队列
4. 任务完成后，自动启动等待中的下一个任务
```

### 3. 线程安全保证
```
1. 使用 concurrent queue 管理共享数据
2. 读操作用 sync
3. 写操作用 async(flags: .barrier)
4. UI更新切换到 main queue
```

这些图表清晰展示了系统的结构、流程和关键机制，有助于理解整体架构。

