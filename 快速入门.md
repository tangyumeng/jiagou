# 快速入门指南

5分钟快速上手多任务下载器！

---

## 🚀 第一步：运行项目

### 1. 打开项目
```bash
cd /Users/tangyumeng/Documents/ios-learn/jiagou
open jiagou.xcodeproj
```

### 2. 选择模拟器
- 选择 iPhone 14 Pro 或任意模拟器
- 点击运行按钮 (⌘R)

### 3. 查看界面
- 应该看到标题为"多任务下载器"的界面
- 左上角有"清除已完成"按钮
- 右上角有"+"按钮

---

## 📥 第二步：添加下载任务

### 方法1：使用测试文件

1. 点击右上角 **"+"** 按钮
2. 选择 **"测试文件 1: 100MB.bin"**
3. 任务自动开始下载

### 方法2：自定义URL

1. 点击右上角 **"+"** 按钮
2. 选择 **"输入自定义URL"**
3. 输入任意下载链接，例如：
   ```
   https://speed.hetzner.de/100MB.bin
   ```
4. 点击"添加"

---

## 🎮 第三步：控制下载

### 暂停下载
点击任务右侧的 **"暂停"** 按钮

### 继续下载
点击任务右侧的 **"继续"** 按钮

### 删除任务
在任务上 **向左滑动**，点击 **"删除"**

### 清除已完成
点击左上角 **"清除已完成"** 按钮

---

## 👀 第四步：观察效果

### 查看进度
- 进度条实时更新
- 显示百分比（如：45.2%）
- 显示下载速度（如：2.5 MB/s）

### 查看状态
- **等待中** - 任务在队列中等待
- **下载中** - 正在下载
- **已暂停** - 用户暂停
- **已完成** - 下载完成
- **失败** - 下载失败（可重试）

### 并发控制
添加多个任务，观察：
- 最多同时下载3个
- 其他任务显示"等待中"
- 任务完成后自动启动下一个

---

## 💻 第五步：查看代码

### 核心文件位置

```
jiagou/
├── DownloadTask.swift          ← 任务模型
├── DownloadManager.swift       ← 下载管理器
├── DownloadTaskCell.swift      ← 自定义Cell
└── ViewController.swift        ← 主控制器
```

### 关键代码片段

#### 1. 添加任务（ViewController.swift）
```swift
// 第156-170行
private func createDownloadTask(urlString: String) {
    guard let url = URL(string: urlString) else {
        showError(message: "无效的URL")
        return
    }
    
    let task = downloadManager.addTask(url: url)
    setupTaskObservers(task)
    tasks.insert(task, at: 0)
    
    tableView.insertRows(at: [IndexPath(row: 0, section: 0)], with: .automatic)
    
    // 自动开始下载
    downloadManager.startDownload(taskId: task.id)
}
```

#### 2. 下载管理器（DownloadManager.swift）
```swift
// 第50-60行
func addTask(url: URL, fileName: String? = nil) -> DownloadTask {
    let task = DownloadTask(url: url, fileName: fileName)
    task.destinationPath = downloadDirectory.appendingPathComponent(task.fileName)
    
    taskQueue.async(flags: .barrier) { [weak self] in
        self?.tasks[task.id] = task
    }
    
    startNextTaskIfPossible()
    return task
}
```

#### 3. 监听进度（ViewController.swift）
```swift
// 第87-97行
private func setupTaskObservers(_ task: DownloadTask) {
    // 进度变化回调
    task.onProgressChanged = { [weak self] _ in
        self?.updateTaskCell(task)
    }
    
    // 状态变化回调
    task.onStateChanged = { [weak self] _ in
        self?.updateTaskCell(task)
    }
}
```

---

## 🎯 常见使用场景

### 场景1：下载大文件
```swift
let url = URL(string: "https://speed.hetzner.de/1GB.bin")!
let task = DownloadManager.shared.addTask(url: url)
DownloadManager.shared.startDownload(taskId: task.id)
```

### 场景2：批量下载
```swift
let urls = [
    "https://example.com/file1.zip",
    "https://example.com/file2.pdf",
    "https://example.com/file3.mp4"
]

for urlString in urls {
    if let url = URL(string: urlString) {
        let task = DownloadManager.shared.addTask(url: url)
        DownloadManager.shared.startDownload(taskId: task.id)
    }
}
```

### 场景3：监听完成事件
```swift
class MyViewController: UIViewController {
    override func viewDidLoad() {
        super.viewDidLoad()
        DownloadManager.shared.delegate = self
    }
}

extension MyViewController: DownloadManagerDelegate {
    func downloadManager(_ manager: DownloadManager, didCompleteTask task: DownloadTask) {
        print("✅ 下载完成: \(task.fileName)")
        // 处理完成的文件
    }
    
    func downloadManager(_ manager: DownloadManager, didFailTask task: DownloadTask, withError error: Error) {
        print("❌ 下载失败: \(error.localizedDescription)")
    }
    
    func downloadManager(_ manager: DownloadManager, didUpdateTask task: DownloadTask) {
        // 更新UI
    }
}
```

---

## 🔧 配置选项

### 修改最大并发数
```swift
// DownloadManager.swift 第25行
private let maxConcurrentDownloads = 3  // 改为你想要的数量
```

### 修改下载目录
```swift
// DownloadManager.swift 第30-42行
private lazy var downloadDirectory: URL = {
    let paths = fileManager.urls(for: .documentDirectory, in: .userDomainMask)
    let documentsDirectory = paths[0]
    return documentsDirectory.appendingPathComponent("Downloads")
}()
```

### 添加测试URL
```swift
// ViewController.swift 第36-42行
private let testURLs = [
    "https://your-custom-url.com/file.zip",
    // 添加更多URL
]
```

---

## 📱 测试建议

### 推荐测试流程

1. **单任务测试**
   - 添加1个任务
   - 测试暂停/继续
   - 测试取消/重新下载

2. **多任务测试**
   - 添加5个任务
   - 观察并发控制（最多3个同时下载）
   - 观察队列管理

3. **大文件测试**
   - 下载1GB文件
   - 测试断点续传
   - 测试后台下载

4. **边界测试**
   - 测试无效URL
   - 测试网络中断
   - 测试磁盘空间不足

---

## 🐛 常见问题

### Q1: 下载速度为0?
**A**: 可能是：
- 网络连接问题
- 服务器响应慢
- 等待其他任务完成

### Q2: 任务一直等待？
**A**: 检查：
- 是否已有3个任务在下载
- 查看其他任务状态

### Q3: 下载失败？
**A**: 可能原因：
- URL无效
- 网络断开
- 服务器错误
- 磁盘空间不足

解决方法：
- 点击"重试"按钮
- 检查网络连接
- 验证URL是否正确

### Q4: 找不到下载的文件？
**A**: 文件保存在：
```
Documents/Downloads/文件名
```

使用代码访问：
```swift
let task = DownloadManager.shared.getTask(byId: taskId)
if let path = task?.destinationPath {
    print("文件路径: \(path.path)")
}
```

---

## 📚 下一步学习

### 初级：理解基础
1. 阅读 `DownloadTask.swift`
2. 理解任务模型和状态
3. 学习观察者模式

### 中级：掌握核心
1. 阅读 `DownloadManager.swift`
2. 理解并发控制逻辑
3. 学习线程安全实现

### 高级：深入架构
1. 阅读 **架构分析.md**
2. 研究设计模式应用
3. 学习架构设计思想

### 实战：动手实践
1. 参考 **使用示例.md**
2. 实现自定义功能
3. 集成到自己项目

---

## 🎓 学习路径

```
第1天：运行项目，体验功能
  ↓
第2天：阅读核心代码，理解逻辑
  ↓
第3天：研究架构文档，学习设计
  ↓
第4天：修改代码，添加功能
  ↓
第5天：集成应用，实际使用
```

---

## 📖 推荐阅读顺序

```
1. 快速入门.md (当前文件) ← 你在这里
2. README.md
3. DownloadTask.swift
4. DownloadManager.swift  
5. ViewController.swift
6. 架构分析.md
7. 类图和流程图.md
8. 使用示例.md
9. 项目总结.md
```

---

## 💡 小贴士

### Tip 1: 使用Xcode调试
- 设置断点查看执行流程
- 使用 `po` 命令查看变量值
- 观察控制台输出

### Tip 2: 修改测试URL
使用这些公开的测试文件：
- 10MB: `https://speed.hetzner.de/10MB.bin`
- 100MB: `https://speed.hetzner.de/100MB.bin`
- 1GB: `https://speed.hetzner.de/1GB.bin`

### Tip 3: 查看下载文件
在Xcode中：
1. Window → Devices and Simulators
2. 选择模拟器
3. 选择应用
4. 查看容器中的文件

### Tip 4: 清理测试数据
```swift
// 删除所有任务
let tasks = DownloadManager.shared.getAllTasks()
tasks.forEach { task in
    DownloadManager.shared.removeTask(taskId: task.id)
}
```

---

## 🎉 开始你的下载器之旅！

现在你已经掌握了基础使用方法，可以：

1. ✅ 运行项目
2. ✅ 添加任务
3. ✅ 控制下载
4. ✅ 查看代码
5. ✅ 理解原理

**接下来，深入学习架构设计，掌握高级技巧吧！**

---

## 📞 需要帮助？

遇到问题时：
1. 查看 **常见问题** 部分
2. 阅读详细文档
3. 检查代码注释
4. 使用调试工具

**祝学习愉快！🚀**

