# ä¸‹è½½ç®¡ç†å™¨ - æŒä¹…åŒ–åŠŸèƒ½è¯¦è§£

## ğŸ“¦ åŠŸèƒ½æ¦‚è¿°

ä¸ºä¸‹è½½ç®¡ç†å™¨æ·»åŠ äº†å®Œæ•´çš„æŒä¹…åŒ–åŠŸèƒ½ï¼Œå®ç° **App é‡å¯åè‡ªåŠ¨æ¢å¤ä¸‹è½½ä»»åŠ¡**ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. **è‡ªåŠ¨ä¿å­˜**
- âœ… æ·»åŠ ä»»åŠ¡æ—¶è‡ªåŠ¨ä¿å­˜
- âœ… æš‚åœä»»åŠ¡æ—¶ä¿å­˜ï¼ˆåŒ…æ‹¬ resumeDataï¼‰
- âœ… ä»»åŠ¡å®Œæˆ/å¤±è´¥æ—¶æ›´æ–°çŠ¶æ€
- âœ… åˆ é™¤ä»»åŠ¡æ—¶ä»æŒä¹…åŒ–ç§»é™¤

### 2. **æ™ºèƒ½æ¢å¤**
- âœ… App å¯åŠ¨æ—¶è‡ªåŠ¨æ¢å¤æœªå®Œæˆçš„ä»»åŠ¡
- âœ… æ¢å¤ä»»åŠ¡çŠ¶æ€å’Œè¿›åº¦
- âœ… æ¢å¤æ–­ç‚¹ç»­ä¼ æ•°æ®
- âœ… æ­£åœ¨ä¸‹è½½çš„ä»»åŠ¡è‡ªåŠ¨æ”¹ä¸ºç­‰å¾…çŠ¶æ€

### 3. **æ•°æ®ç®¡ç†**
- âœ… ä½¿ç”¨ UserDefaults å­˜å‚¨ï¼ˆè½»é‡ã€å¿«é€Ÿï¼‰
- âœ… æ”¯æŒæ–‡ä»¶å­˜å‚¨ï¼ˆå¤§æ•°æ®é‡æ—¶ä½¿ç”¨ï¼‰
- âœ… æœ€å¤šä¿å­˜ 100 ä¸ªä»»åŠ¡
- âœ… è‡ªåŠ¨æ¸…ç†å·²å®Œæˆä»»åŠ¡

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç±»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DownloadTaskPersistence.swift     â”‚
â”‚   æŒä¹…åŒ–ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰               â”‚
â”‚   - ä¿å­˜/åŠ è½½ä»»åŠ¡                    â”‚
â”‚   - UserDefaults / æ–‡ä»¶å­˜å‚¨          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    DownloadManager.swift             â”‚
â”‚    - é›†æˆæŒä¹…åŒ–è°ƒç”¨                  â”‚
â”‚    - App å¯åŠ¨æ—¶æ¢å¤ä»»åŠ¡              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     DownloadTask.swift               â”‚
â”‚     - æ”¯æŒåºåˆ—åŒ–/ååºåˆ—åŒ–            â”‚
â”‚     - convenience init(from:)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æ¨¡å‹

```swift
// å¯åºåˆ—åŒ–çš„çŠ¶æ€æšä¸¾
enum SerializableDownloadState: String, Codable {
    case waiting, downloading, paused
    case completed, failed, cancelled
}

// å¯åºåˆ—åŒ–çš„ä»»åŠ¡æ•°æ®
struct DownloadTaskData: Codable {
    let id: String
    let url: String
    let fileName: String
    var state: SerializableDownloadState
    var progress: Double
    var totalBytes: Int64
    var downloadedBytes: Int64
    var destinationPath: String?
    var resumeData: Data?  // æ–­ç‚¹ç»­ä¼ æ•°æ®
    var errorDescription: String?
    let createdAt: TimeInterval
}
```

---

## ğŸ’» ä½¿ç”¨æ–¹æ³•

### 1. è‡ªåŠ¨æŒä¹…åŒ–ï¼ˆæ— éœ€æ‰‹åŠ¨è°ƒç”¨ï¼‰

æŒä¹…åŒ–åŠŸèƒ½å·²ç»é›†æˆåˆ° `DownloadManager` ä¸­ï¼Œæ‰€æœ‰æ“ä½œè‡ªåŠ¨ä¿å­˜ï¼š

```swift
let manager = DownloadManager.shared

// æ·»åŠ ä»»åŠ¡ â†’ è‡ªåŠ¨ä¿å­˜
let task = manager.addTask(url: url, fileName: "file.zip")

// æš‚åœä»»åŠ¡ â†’ è‡ªåŠ¨ä¿å­˜ï¼ˆåŒ…æ‹¬ resumeDataï¼‰
manager.pauseDownload(taskId: task.id)

// åˆ é™¤ä»»åŠ¡ â†’ è‡ªåŠ¨ä»æŒä¹…åŒ–ç§»é™¤
manager.removeTask(taskId: task.id)
```

### 2. æ‰‹åŠ¨ä¿å­˜å•ä¸ªä»»åŠ¡

```swift
// æ–¹å¼1ï¼šé€šè¿‡ task æ‰©å±•
task.save()

// æ–¹å¼2ï¼šé€šè¿‡æŒä¹…åŒ–ç®¡ç†å™¨
DownloadTaskPersistence.shared.saveTask(task)
```

### 3. App å¯åŠ¨æ—¶è‡ªåŠ¨æ¢å¤

```swift
// DownloadManager åˆå§‹åŒ–æ—¶è‡ªåŠ¨è°ƒç”¨
private func restoreTasksFromPersistence() {
    let taskDataArray = DownloadTaskPersistence.shared.loadTasks()
    
    for taskData in taskDataArray {
        let task = DownloadTask(from: taskData)
        tasks[task.id] = task
        
        // æ­£åœ¨ä¸‹è½½çš„ä»»åŠ¡æ”¹ä¸ºç­‰å¾…çŠ¶æ€
        if task.state == .downloading {
            task.state = .waiting
        }
    }
}
```

### 4. æ‰‹åŠ¨ç®¡ç†æŒä¹…åŒ–

```swift
// æ¸…ç©ºæ‰€æœ‰æŒä¹…åŒ–ä»»åŠ¡
DownloadTaskPersistence.shared.clearAllTasks()

// æ¸…ç†å·²å®Œæˆçš„ä»»åŠ¡
DownloadTaskPersistence.shared.clearCompletedTasks()

// åˆ é™¤æŒ‡å®šä»»åŠ¡
DownloadTaskPersistence.shared.removeTask(withId: taskId)

// åŠ è½½æ‰€æœ‰ä»»åŠ¡
let taskDataArray = DownloadTaskPersistence.shared.loadTasks()
```

---

## ğŸ¯ æŠ€æœ¯å®ç°

### 1. Codable åºåˆ—åŒ–

```swift
// ç¼–ç ï¼ˆä¿å­˜ï¼‰
let encoder = JSONEncoder()
let data = try encoder.encode(taskDataArray)
userDefaults.set(data, forKey: tasksKey)

// è§£ç ï¼ˆåŠ è½½ï¼‰
let decoder = JSONDecoder()
let taskDataArray = try decoder.decode([DownloadTaskData].self, from: data)
```

### 2. æ–­ç‚¹ç»­ä¼ æ•°æ®ä¿å­˜

```swift
// resumeData æ˜¯ Data ç±»å‹ï¼Œè‡ªåŠ¨æ”¯æŒ Codable
struct DownloadTaskData: Codable {
    var resumeData: Data?  // æš‚åœæ—¶ä¿å­˜ï¼Œæ¢å¤æ—¶ä½¿ç”¨
}

// æš‚åœæ—¶ä¿å­˜
task.downloadTask?.cancel(byProducingResumeData: { resumeData in
    task.resumeData = resumeData
    task.state = .paused
    // è‡ªåŠ¨æŒä¹…åŒ–
})

// æ¢å¤æ—¶ä½¿ç”¨
if let resumeData = task.resumeData {
    let downloadTask = session.downloadTask(withResumeData: resumeData)
    downloadTask.resume()
}
```

### 3. ä»»åŠ¡çŠ¶æ€è¿‡æ»¤

```swift
// åªä¿å­˜æœ‰æ„ä¹‰çš„ä»»åŠ¡ï¼ˆæœªå®Œæˆçš„ï¼‰
let tasksToSave = tasks.filter { task in
    task.state == .waiting || 
    task.state == .downloading || 
    task.state == .paused
}
```

### 4. æ–‡ä»¶å­˜å‚¨ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰

å½“ä»»åŠ¡æ•°é‡è¾ƒå¤šæ—¶ï¼Œå¯ä½¿ç”¨æ–‡ä»¶å­˜å‚¨ï¼š

```swift
// ä¿å­˜åˆ°æ–‡ä»¶
DownloadTaskPersistence.shared.saveTasksToFile(tasks)

// ä»æ–‡ä»¶åŠ è½½
let taskDataArray = DownloadTaskPersistence.shared.loadTasksFromFile()
```

å­˜å‚¨ä½ç½®ï¼š`Documents/DownloadTasks/tasks.json`

---

## ğŸ“Š æŒä¹…åŒ–ç­–ç•¥

### ä¿å­˜æ—¶æœº

| æ“ä½œ | æ˜¯å¦ä¿å­˜ | ä¿å­˜å†…å®¹ |
|------|---------|---------|
| æ·»åŠ ä»»åŠ¡ | âœ… | ä»»åŠ¡åŸºæœ¬ä¿¡æ¯ |
| å¼€å§‹ä¸‹è½½ | âŒ | çŠ¶æ€ç”±ç³»ç»Ÿç®¡ç† |
| æš‚åœä¸‹è½½ | âœ… | çŠ¶æ€ + resumeData |
| ç»§ç»­ä¸‹è½½ | âŒ | ä½¿ç”¨å·²ä¿å­˜çš„ resumeData |
| ä»»åŠ¡å®Œæˆ | âœ… | æ›´æ–°çŠ¶æ€ä¸ºå·²å®Œæˆ |
| ä»»åŠ¡å¤±è´¥ | âœ… | æ›´æ–°çŠ¶æ€ä¸ºå¤±è´¥ |
| åˆ é™¤ä»»åŠ¡ | âœ… | ä»æŒä¹…åŒ–ç§»é™¤ |
| æ¸…é™¤å·²å®Œæˆ | âœ… | æ‰¹é‡ç§»é™¤ |

### ä¸ä¿å­˜çš„å†…å®¹

âŒ å·²å®Œæˆçš„ä»»åŠ¡ï¼ˆé™¤éæ‰‹åŠ¨æŒ‡å®šï¼‰  
âŒ å·²å–æ¶ˆçš„ä»»åŠ¡  
âŒ å¤±è´¥çš„ä»»åŠ¡ï¼ˆå¯é€‰ï¼Œç›®å‰ä¿å­˜ï¼‰  
âŒ è¶…è¿‡ 100 ä¸ªçš„ä»»åŠ¡ï¼ˆåªä¿ç•™å‰ 100 ä¸ªï¼‰  

---

## ğŸ” è°ƒè¯•å’Œæ—¥å¿—

æ‰€æœ‰æŒä¹…åŒ–æ“ä½œéƒ½ä¼šæ‰“å°æ—¥å¿—ï¼š

```
ğŸ”„ å¼€å§‹æ¢å¤ 3 ä¸ªä»»åŠ¡...
âœ… æ¢å¤ä»»åŠ¡ï¼šfile1.zip - å·²æš‚åœ
âœ… æ¢å¤ä»»åŠ¡ï¼šfile2.pdf - ç­‰å¾…ä¸­
âœ… æ¢å¤ä»»åŠ¡ï¼šfile3.mp4 - å·²æš‚åœ
ğŸ“‹ ä»»åŠ¡æ¢å¤å®Œæˆ

âœ… æŒä¹…åŒ–ï¼šå·²ä¿å­˜ 3 ä¸ªä»»åŠ¡
âŒ æŒä¹…åŒ–å¤±è´¥ï¼šæ— æ³•ç¼–ç æ•°æ®
```

---

## ğŸ¤ é¢è¯•è¦ç‚¹

### 1. ä¸ºä»€ä¹ˆé€‰æ‹© UserDefaultsï¼Ÿ

```
ä¼˜ç‚¹ï¼š
âœ… ç®€å•æ˜“ç”¨ï¼Œæ— éœ€é…ç½®
âœ… è½»é‡æ•°æ®å­˜å‚¨ï¼Œè¯»å†™å¿«é€Ÿ
âœ… é€‚åˆå­˜å‚¨å°‘é‡ç»“æ„åŒ–æ•°æ®ï¼ˆ<1MBï¼‰
âœ… è‡ªåŠ¨æŒä¹…åŒ–åˆ°ç£ç›˜

ç¼ºç‚¹ï¼š
âŒ ä¸é€‚åˆå¤§é‡æ•°æ®
âŒ ä¸æ”¯æŒå¤æ‚æŸ¥è¯¢
âŒ çº¿ç¨‹å®‰å…¨æ€§éœ€è¦æ³¨æ„

é€‚ç”¨åœºæ™¯ï¼š
- ä¸‹è½½ä»»åŠ¡åˆ—è¡¨ï¼ˆ<100ä¸ªï¼‰
- ç”¨æˆ·è®¾ç½®å’Œé…ç½®
- ç®€å•çš„çŠ¶æ€ä¿å­˜
```

### 2. ä¸ºä»€ä¹ˆä¸ç”¨ CoreDataï¼Ÿ

```
CoreData é€‚åˆï¼š
- å¤æ‚çš„å…³ç³»å‹æ•°æ®
- å¤§é‡æ•°æ®ï¼ˆæ•°åƒæ¡ä»¥ä¸Šï¼‰
- éœ€è¦å¤æ‚æŸ¥è¯¢å’Œæ’åº
- æ•°æ®è¿ç§»éœ€æ±‚

æœ¬é¡¹ç›®ï¼š
- æ•°æ®é‡å°ï¼ˆ<100ä¸ªä»»åŠ¡ï¼‰
- æ•°æ®ç»“æ„ç®€å•
- UserDefaults è¶³å¤Ÿä¸”æ›´ç®€å•
```

### 3. å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Ÿ

```swift
// UserDefaults æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„
// ä½†é…åˆ DownloadManager çš„é˜Ÿåˆ—ä½¿ç”¨æ›´å®‰å…¨

taskQueue.async(flags: .barrier) {
    // ä¿®æ”¹ä»»åŠ¡åä¿å­˜
    self.tasks[task.id] = task
    DispatchQueue.main.async {
        self.saveTasksToPersistence()
    }
}
```

### 4. æ–­ç‚¹ç»­ä¼ æ•°æ®å¦‚ä½•æŒä¹…åŒ–ï¼Ÿ

```swift
// resumeData æ˜¯ Data ç±»å‹ï¼Œæ”¯æŒ Codable
struct DownloadTaskData: Codable {
    var resumeData: Data?  // è‡ªåŠ¨åºåˆ—åŒ–/ååºåˆ—åŒ–
}

// æš‚åœæ—¶ï¼š
task.downloadTask?.cancel(byProducingResumeData: { resumeData in
    task.resumeData = resumeData  // ä¿å­˜
    // æŒä¹…åŒ–åˆ° UserDefaults
})

// æ¢å¤æ—¶ï¼š
if let resumeData = task.resumeData {
    let downloadTask = session.downloadTask(withResumeData: resumeData)
}
```

### 5. å¦‚ä½•ä¼˜åŒ–å¤§æ•°æ®é‡ï¼Ÿ

```swift
// æ–¹æ¡ˆ1ï¼šé™åˆ¶ä¿å­˜æ•°é‡
let limitedTasks = Array(taskDataArray.prefix(100))

// æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ–‡ä»¶å­˜å‚¨
saveTasksToFile(tasks)  // JSON æ–‡ä»¶

// æ–¹æ¡ˆ3ï¼šåªä¿å­˜å…³é”®ä¿¡æ¯
// ä¸ä¿å­˜å·²å®Œæˆã€å·²å–æ¶ˆçš„ä»»åŠ¡

// æ–¹æ¡ˆ4ï¼šä½¿ç”¨ CoreData æˆ– Realm
// æ”¯æŒæ›´å¤§æ•°æ®é‡å’Œå¤æ‚æŸ¥è¯¢
```

---

## ğŸš€ æ‰©å±•æ–¹å‘

### çŸ­æœŸä¼˜åŒ–

1. **å¢é‡ä¿å­˜**
   - åªä¿å­˜å˜åŒ–çš„ä»»åŠ¡ï¼Œè€Œéæ¯æ¬¡å…¨é‡ä¿å­˜
   - å‡å°‘ I/O æ“ä½œ

2. **å¼‚æ­¥ä¿å­˜**
   - ä½¿ç”¨åå°é˜Ÿåˆ—è¿›è¡ŒæŒä¹…åŒ–
   - ä¸é˜»å¡ä¸»çº¿ç¨‹

3. **æ•°æ®å‹ç¼©**
   - å¯¹ resumeData è¿›è¡Œå‹ç¼©
   - å‡å°‘å­˜å‚¨ç©ºé—´

### ä¸­æœŸä¼˜åŒ–

4. **è¿ç§»åˆ° CoreData**
   - æ”¯æŒæ›´å¤§æ•°æ®é‡
   - æ”¯æŒå¤æ‚æŸ¥è¯¢å’Œæ’åº
   - è‡ªåŠ¨æ•°æ®è¿ç§»

5. **äº‘åŒæ­¥**
   - iCloud åŒæ­¥ä¸‹è½½ä»»åŠ¡
   - å¤šè®¾å¤‡å…±äº«ä¸‹è½½åˆ—è¡¨

6. **æ•°æ®åŠ å¯†**
   - æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
   - Keychain å­˜å‚¨å…³é”®ä¿¡æ¯

---

## ğŸ“ æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•

```swift
// 1. æµ‹è¯•ä¿å­˜å’ŒåŠ è½½
let task = DownloadTask(url: url, fileName: "test.zip")
task.save()
let loaded = DownloadTaskPersistence.shared.loadTasks()
// éªŒè¯ï¼šloaded åŒ…å« task

// 2. æµ‹è¯•æ–­ç‚¹ç»­ä¼ æ•°æ®
// æš‚åœä»»åŠ¡ â†’ æ€æ‰ App â†’ é‡å¯
// éªŒè¯ï¼šresumeData æ­£ç¡®æ¢å¤

// 3. æµ‹è¯•çŠ¶æ€è½¬æ¢
// ä¸‹è½½ä¸­çš„ä»»åŠ¡ï¼Œé‡å¯ååº”è¯¥å˜ä¸ºç­‰å¾…çŠ¶æ€

// 4. æµ‹è¯•æ•°æ®æ¸…ç†
// æ¸…é™¤å·²å®Œæˆä»»åŠ¡ï¼ŒéªŒè¯æŒä¹…åŒ–æ•°æ®æ­£ç¡®
```

### æ€§èƒ½æµ‹è¯•

```swift
// 1. å¤§é‡ä»»åŠ¡ä¿å­˜
for i in 0..<200 {
    addTask(...)
}
// éªŒè¯ï¼šåªä¿å­˜å‰ 100 ä¸ª

// 2. é¢‘ç¹ä¿å­˜
// å¿«é€Ÿæ·»åŠ /åˆ é™¤ä»»åŠ¡
// éªŒè¯ï¼šä¸ä¼šé€ æˆå¡é¡¿
```

---

## ğŸ’¡ æ€»ç»“

### å®ç°çš„åŠŸèƒ½

âœ… åŸºäº UserDefaults çš„è½»é‡çº§æŒä¹…åŒ–  
âœ… è‡ªåŠ¨ä¿å­˜å’Œæ¢å¤ä¸‹è½½ä»»åŠ¡  
âœ… æ”¯æŒæ–­ç‚¹ç»­ä¼ æ•°æ®æŒä¹…åŒ–  
âœ… æ™ºèƒ½çŠ¶æ€ç®¡ç†å’Œæ¢å¤  
âœ… å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—  
âœ… æ”¯æŒæ–‡ä»¶å­˜å‚¨ï¼ˆå¤§æ•°æ®é‡ï¼‰  

### æŠ€æœ¯äº®ç‚¹

â­ Codable åè®®ä¼˜é›…å®ç°åºåˆ—åŒ–  
â­ å•ä¾‹æ¨¡å¼ç»Ÿä¸€ç®¡ç†æŒä¹…åŒ–  
â­ è‡ªåŠ¨åŒ–ä¿å­˜ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨  
â­ ä¸ DownloadManager æ— ç¼é›†æˆ  
â­ æ‰©å±•æ€§å¼ºï¼Œæ˜“äºå‡çº§åˆ° CoreData  

### é¢è¯•ä»·å€¼

ğŸ¯ å±•ç¤ºæ•°æ®æŒä¹…åŒ–èƒ½åŠ›  
ğŸ¯ ç†è§£åºåˆ—åŒ–/ååºåˆ—åŒ–åŸç†  
ğŸ¯ æŒæ¡ UserDefaults ä½¿ç”¨  
ğŸ¯ äº†è§£ CoreData çš„é€‰å‹è€ƒè™‘  
ğŸ¯ å®è·µäº†æ¶æ„è®¾è®¡èƒ½åŠ›  

---

**æŒä¹…åŒ–åŠŸèƒ½è®©ä¸‹è½½ç®¡ç†å™¨æ›´åŠ å®Œæ•´å’Œå®ç”¨ï¼ğŸ‰**

