# å›¾ç‰‡åŠ è½½æ¡†æ¶ - ç±»ä¼¼ SDWebImage

## ğŸ“¦ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„å›¾ç‰‡åŠ è½½æ¡†æ¶ï¼Œæ”¯æŒ**ä¸‰çº§ç¼“å­˜**ï¼ˆå†…å­˜-ç£ç›˜-ç½‘ç»œï¼‰ã€**è‡ªåŠ¨ä¸‹è½½**ã€**é˜²æ­¢é‡å¤ä¸‹è½½**ç­‰åŠŸèƒ½ï¼Œç±»ä¼¼äº SDWebImageã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. **ä¸‰çº§ç¼“å­˜ç­–ç•¥**
```
è¯·æ±‚å›¾ç‰‡ â†’ å†…å­˜ç¼“å­˜ â†’ ç£ç›˜ç¼“å­˜ â†’ ç½‘ç»œä¸‹è½½
           â†“ å‘½ä¸­       â†“ å‘½ä¸­       â†“ ä¸‹è½½
         ç«‹å³è¿”å›    å¼‚æ­¥è¿”å›    å¼‚æ­¥ä¸‹è½½+ç¼“å­˜
```

### 2. **æ™ºèƒ½ç¼“å­˜ç®¡ç†**
- âœ… NSCache è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼ˆå†…å­˜è­¦å‘Šæ—¶è‡ªåŠ¨æ¸…ç†ï¼‰
- âœ… ç£ç›˜ç¼“å­˜è‡ªåŠ¨è¿‡æœŸæ¸…ç†ï¼ˆé»˜è®¤ 7 å¤©ï¼‰
- âœ… ç£ç›˜ç¼“å­˜å¤§å°é™åˆ¶ï¼ˆé»˜è®¤ 100MBï¼‰
- âœ… LRU ç­–ç•¥ï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰

### 3. **é«˜æ€§èƒ½ä¸‹è½½**
- âœ… é˜²æ­¢é‡å¤ä¸‹è½½ï¼ˆå¤šä¸ªè¯·æ±‚åˆå¹¶ï¼‰
- âœ… å¹¶å‘æ§åˆ¶ï¼ˆæœ€å¤š 4 ä¸ªå¹¶å‘ä¸‹è½½ï¼‰
- âœ… è‡ªåŠ¨é‡è¯•ï¼ˆå¤±è´¥åé‡è¯• 2 æ¬¡ï¼‰
- âœ… ä¸‹è½½è¶…æ—¶æ§åˆ¶ï¼ˆ15 ç§’ï¼‰

### 4. **UI é›†æˆ**
- âœ… UIImageView æ‰©å±•ï¼Œä¸€è¡Œä»£ç åŠ è½½å›¾ç‰‡
- âœ… å ä½å›¾æ”¯æŒ
- âœ… æ·¡å…¥åŠ¨ç”»
- âœ… Cell å¤ç”¨å®‰å…¨ï¼ˆè‡ªåŠ¨å–æ¶ˆä¸‹è½½ï¼‰

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç±»ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ImageCacheManager              â”‚
â”‚         ç¼“å­˜ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰              â”‚
â”‚  - å†…å­˜ç¼“å­˜ï¼ˆNSCacheï¼‰                  â”‚
â”‚  - ç£ç›˜ç¼“å­˜ï¼ˆFileManagerï¼‰              â”‚
â”‚  - ç¼“å­˜æ¸…ç†ç­–ç•¥                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ImageLoader                 â”‚
â”‚           å›¾ç‰‡åŠ è½½å™¨ï¼ˆå•ä¾‹ï¼‰            â”‚
â”‚  - ç½‘ç»œä¸‹è½½ï¼ˆURLSessionï¼‰               â”‚
â”‚  - å›è°ƒç®¡ç†                             â”‚
â”‚  - é˜²é‡å¤ä¸‹è½½                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       UIImageView+Extension            â”‚
â”‚           ä¾¿æ·æ‰©å±•æ–¹æ³•                  â”‚
â”‚  - setImage(with:placeholder:)         â”‚
â”‚  - è‡ªåŠ¨ç¼“å­˜+ä¸‹è½½                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¼“å­˜ç­–ç•¥æµç¨‹å›¾

```
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  è¯·æ±‚å›¾ç‰‡    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  å†…å­˜ç¼“å­˜?   â”‚
                   â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                  æ˜¯ â”‚        â”‚ å¦
              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”     â”‚
              â”‚ ç«‹å³è¿”å› â”‚     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
                          â”‚ ç£ç›˜ç¼“å­˜?â”‚
                          â””â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”˜
                         æ˜¯ â”‚   â”‚ å¦
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”  â”‚
                    â”‚å¼‚æ­¥è¿”å› â”‚  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                           â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                           â”‚  ç½‘ç»œä¸‹è½½  â”‚
                           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ ä¿å­˜åˆ°å†…å­˜+ç£ç›˜ â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                           â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                           â”‚  è¿”å›å›¾ç‰‡  â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨ï¼ˆUIImageView æ‰©å±•ï¼‰

```swift
import UIKit

// æœ€ç®€å•çš„ä½¿ç”¨
imageView.setImage(with: url)

// å¸¦å ä½å›¾
imageView.setImage(with: url, placeholder: UIImage(named: "placeholder"))

// å¸¦æ·¡å…¥åŠ¨ç”»
imageView.setImage(
    with: url,
    placeholder: UIImage(named: "placeholder"),
    transition: .fade(duration: 0.3)
)

// å¸¦å®Œæˆå›è°ƒ
imageView.setImage(with: url, placeholder: placeholder) { result in
    switch result {
    case .success(let image):
        print("âœ… å›¾ç‰‡åŠ è½½æˆåŠŸï¼š\(image.size)")
    case .failure(let error):
        print("âŒ å›¾ç‰‡åŠ è½½å¤±è´¥ï¼š\(error)")
    }
}
```

### 2. TableView / CollectionView ä¸­ä½¿ç”¨

```swift
func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
    let cell = tableView.dequeueReusableCell(withIdentifier: "Cell", for: indexPath)
    let url = urls[indexPath.row]
    
    // è‡ªåŠ¨å¤„ç† cell å¤ç”¨ï¼Œä¸ä¼šå‡ºç°å›¾ç‰‡é”™ä¹±
    cell.imageView?.setImage(
        with: url,
        placeholder: UIImage(named: "placeholder"),
        transition: .fade(duration: 0.2)
    )
    
    return cell
}

// åœ¨ prepareForReuse ä¸­å–æ¶ˆåŠ è½½ï¼ˆå¯é€‰ï¼Œè‡ªåŠ¨å¤„ç†ï¼‰
override func prepareForReuse() {
    super.prepareForReuse()
    imageView?.cancelImageLoad()
}
```

### 3. ç›´æ¥ä½¿ç”¨ ImageLoader

```swift
let loader = ImageLoader.shared

// åŠ è½½å›¾ç‰‡
loader.loadImage(from: url) { result in
    switch result {
    case .success(let image):
        self.imageView.image = image
    case .failure(let error):
        print("åŠ è½½å¤±è´¥ï¼š\(error)")
    }
}

// å¼ºåˆ¶åˆ·æ–°ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰
var options = ImageLoadOptions()
options.forceRefresh = true
loader.loadImage(from: url, options: options) { result in
    // ...
}

// å–æ¶ˆä¸‹è½½
loader.cancelDownload(for: url)

// é¢„åŠ è½½å›¾ç‰‡
let urls = [url1, url2, url3]
loader.prefetchImages(urls: urls)
```

### 4. ç¼“å­˜ç®¡ç†

```swift
let loader = ImageLoader.shared

// æ¸…ç©ºå†…å­˜ç¼“å­˜
loader.clearMemoryCache()

// æ¸…ç©ºç£ç›˜ç¼“å­˜
loader.clearDiskCache {
    print("ç£ç›˜ç¼“å­˜å·²æ¸…ç©º")
}

// æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
loader.clearAllCache {
    print("æ‰€æœ‰ç¼“å­˜å·²æ¸…ç©º")
}

// è·å–ç¼“å­˜å¤§å°
loader.getCacheSize { sizeString in
    print("ç¼“å­˜å¤§å°ï¼š\(sizeString)")  // ä¾‹å¦‚ï¼š"25.3 MB"
}
```

### 5. ç›´æ¥ä½¿ç”¨ ImageCacheManager

```swift
let cacheManager = ImageCacheManager.shared

// æ‰‹åŠ¨ç¼“å­˜å›¾ç‰‡
cacheManager.cacheImage(image, for: url)

// ä»ç¼“å­˜è·å–å›¾ç‰‡
cacheManager.cachedImage(for: url) { image in
    if let image = image {
        print("ä»ç¼“å­˜è·å–æˆåŠŸ")
    }
}

// æ¸…ç†è¿‡æœŸç¼“å­˜
cacheManager.cleanExpiredDiskCache()

// è·å–ç¼“å­˜ç»Ÿè®¡
cacheManager.getDiskCacheSize { size in
    print("ç£ç›˜ç¼“å­˜å¤§å°ï¼š\(size) å­—èŠ‚")
}

cacheManager.getDiskCacheCount { count in
    print("ç£ç›˜ç¼“å­˜æ–‡ä»¶æ•°ï¼š\(count)")
}
```

---

## ğŸ¯ æ ¸å¿ƒæŠ€æœ¯å®ç°

### 1. å†…å­˜ç¼“å­˜ - NSCache

```swift
private let memoryCache = NSCache<NSString, UIImage>()

// é…ç½®
memoryCache.countLimit = 100              // æœ€å¤šç¼“å­˜ 100 å¼ 
memoryCache.totalCostLimit = 50 * 1024 * 1024  // æœ€å¤§ 50MB

// ä¿å­˜
let cost = image.imageCost  // å›¾ç‰‡å†…å­˜å ç”¨
memoryCache.setObject(image, forKey: key, cost: cost)

// è¯»å–
let image = memoryCache.object(forKey: key)

// NSCache ä¼˜åŠ¿ï¼š
// âœ… è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œå†…å­˜è­¦å‘Šæ—¶è‡ªåŠ¨æ¸…ç†
// âœ… çº¿ç¨‹å®‰å…¨
// âœ… æ”¯æŒ cost é™åˆ¶ï¼ˆæŒ‰å†…å­˜å¤§å°é™åˆ¶ï¼‰
```

**ä¸ºä»€ä¹ˆé€‰æ‹© NSCache è€Œä¸æ˜¯ Dictionaryï¼Ÿ**
- âœ… è‡ªåŠ¨å†…å­˜ç®¡ç†
- âœ… çº¿ç¨‹å®‰å…¨
- âœ… å†…å­˜è­¦å‘Šæ—¶è‡ªåŠ¨æ¸…ç†
- âœ… æ”¯æŒ cost å’Œ count åŒé‡é™åˆ¶

### 2. ç£ç›˜ç¼“å­˜ - FileManager

```swift
// ç¼“å­˜ç›®å½•
let cacheDirectory = .cachesDirectory/ImageCache

// ç¼“å­˜é”®ï¼ˆURL çš„ MD5ï¼‰
let cacheKey = url.absoluteString.md5
let cachePath = cacheDirectory/cacheKey

// ä¿å­˜ï¼ˆå¼‚æ­¥ï¼‰
ioQueue.async {
    let data = image.jpegData(compressionQuality: 0.8)
    try? data.write(to: cachePath)
}

// è¯»å–ï¼ˆå¼‚æ­¥ï¼‰
ioQueue.async {
    let data = try? Data(contentsOf: cachePath)
    let image = UIImage(data: data)
    DispatchQueue.main.async { completion(image) }
}

// æ¸…ç†ç­–ç•¥ï¼š
// 1. æ—¶é—´è¿‡æœŸï¼šè¶…è¿‡ 7 å¤©è‡ªåŠ¨åˆ é™¤
// 2. å¤§å°è¶…é™ï¼šåˆ é™¤æœ€æ—§çš„æ–‡ä»¶
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ MD5 ä½œä¸ºç¼“å­˜é”®ï¼Ÿ**
- âœ… URL å¯èƒ½å¾ˆé•¿ï¼ŒMD5 å›ºå®šé•¿åº¦
- âœ… URL å¯èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ŒMD5 å®‰å…¨
- âœ… å”¯ä¸€æ€§ä¿è¯

### 3. é˜²æ­¢é‡å¤ä¸‹è½½

```swift
// é—®é¢˜ï¼šå¤šä¸ª ImageView è¯·æ±‚åŒä¸€å¼ å›¾ç‰‡
// è§£å†³ï¼šåˆå¹¶è¯·æ±‚ï¼Œåªä¸‹è½½ä¸€æ¬¡

// å›è°ƒå­—å…¸
private var downloadCallbacks: [URL: [(Result<UIImage, Error>) -> Void]] = [:]

// æ·»åŠ å›è°ƒ
if downloadTasks[url] != nil {
    // å·²ç»åœ¨ä¸‹è½½ï¼Œæ·»åŠ åˆ°å›è°ƒåˆ—è¡¨
    downloadCallbacks[url]?.append(completion)
    return
}

// ä¸‹è½½å®Œæˆåé€šçŸ¥æ‰€æœ‰å›è°ƒ
let callbacks = downloadCallbacks[url]
callbacks?.forEach { $0(.success(image)) }
```

### 4. Cell å¤ç”¨å®‰å…¨

```swift
// é—®é¢˜ï¼šTableView å¿«é€Ÿæ»šåŠ¨æ—¶ï¼Œå›¾ç‰‡é”™ä¹±
// åŸå› ï¼šcell å¤ç”¨ï¼Œå¼‚æ­¥ä¸‹è½½å®Œæˆæ—¶ cell å¯èƒ½å·²ç»æ˜¾ç¤ºå…¶ä»–å†…å®¹

// è§£å†³æ–¹æ¡ˆï¼šä¿å­˜å½“å‰ URL
private var imageURL: URL?  // å…³è”å¯¹è±¡

func setImage(with url: URL?) {
    // ä¿å­˜å½“å‰ URL
    self.imageURL = url
    
    ImageLoader.shared.loadImage(from: url) { [weak self] result in
        guard let self = self else { return }
        
        // æ£€æŸ¥ URL æ˜¯å¦åŒ¹é…
        guard self.imageURL == url else { return }
        
        // è®¾ç½®å›¾ç‰‡
        self.image = image
    }
}
```

### 5. è‡ªåŠ¨é‡è¯•æœºåˆ¶

```swift
private func downloadImage(
    from url: URL,
    retryCount: Int,  // å‰©ä½™é‡è¯•æ¬¡æ•°
    completion: @escaping (Result<UIImage, Error>) -> Void
) {
    urlSession.dataTask(with: url) { data, response, error in
        if let error = error {
            // è¿˜æœ‰é‡è¯•æ¬¡æ•°ï¼Œç»§ç»­é‡è¯•
            if retryCount > 0 {
                self.downloadImage(from: url, retryCount: retryCount - 1, completion: completion)
            } else {
                completion(.failure(error))
            }
        }
    }
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å¼‚æ­¥æ“ä½œ

```swift
// æ‰€æœ‰ç£ç›˜ I/O éƒ½åœ¨åå°é˜Ÿåˆ—
private let ioQueue = DispatchQueue(label: "...", qos: .background)

ioQueue.async {
    // è¯»å†™ç£ç›˜
    DispatchQueue.main.async {
        // å›è°ƒä¸»çº¿ç¨‹
    }
}
```

### 2. å¹¶å‘æ§åˆ¶

```swift
// æœ€å¤š 4 ä¸ªå¹¶å‘ä¸‹è½½
private let downloadQueue = OperationQueue()
downloadQueue.maxConcurrentOperationCount = 4
```

### 3. å›¾ç‰‡è§£ç ä¼˜åŒ–

```swift
// JPEG å‹ç¼©è´¨é‡ 0.8ï¼ˆå¹³è¡¡è´¨é‡å’Œå¤§å°ï¼‰
let data = image.jpegData(compressionQuality: 0.8)

// å¯æ‰©å±•ï¼šæ”¯æŒ WebPã€HEIC ç­‰æ ¼å¼
```

### 4. å†…å­˜è®¡ç®—

```swift
// å‡†ç¡®è®¡ç®—å›¾ç‰‡å†…å­˜å ç”¨
var imageCost: Int {
    guard let cgImage = cgImage else { return 0 }
    return cgImage.bytesPerRow * cgImage.height
}
```

---

## ğŸ¤ é¢è¯•è¦ç‚¹

### 1. ä¸ºä»€ä¹ˆéœ€è¦ä¸‰çº§ç¼“å­˜ï¼Ÿ

```
å†…å­˜ç¼“å­˜ï¼š
âœ… æœ€å¿«ï¼ˆçº³ç§’çº§ï¼‰
âœ… å®¹é‡å°ï¼ˆ50MBï¼‰
âœ… App é€€å‡ºåæ¸…ç©º
é€‚åˆï¼šæœ€è¿‘ä½¿ç”¨çš„å›¾ç‰‡

ç£ç›˜ç¼“å­˜ï¼š
âœ… è¾ƒå¿«ï¼ˆæ¯«ç§’çº§ï¼‰
âœ… å®¹é‡å¤§ï¼ˆ100MBï¼‰
âœ… æŒä¹…åŒ–å­˜å‚¨
é€‚åˆï¼šæ‰€æœ‰ä¸‹è½½è¿‡çš„å›¾ç‰‡

ç½‘ç»œä¸‹è½½ï¼š
âŒ æœ€æ…¢ï¼ˆç§’çº§ï¼‰
âŒ æ¶ˆè€—æµé‡
âŒ éœ€è¦ç½‘ç»œ
å…œåº•æ–¹æ¡ˆï¼šç¼“å­˜æ²¡æœ‰æ—¶æ‰ä¸‹è½½
```

### 2. å¦‚ä½•é˜²æ­¢é‡å¤ä¸‹è½½ï¼Ÿ

```swift
// ç»´æŠ¤ä¸‹è½½ä»»åŠ¡å­—å…¸
private var downloadTasks: [URL: URLSessionDataTask] = [:]

// ç»´æŠ¤å›è°ƒåˆ—è¡¨
private var downloadCallbacks: [URL: [Callback]] = [:]

// é€»è¾‘ï¼š
1. æ£€æŸ¥ URL æ˜¯å¦å·²ç»åœ¨ä¸‹è½½
2. å¦‚æœæ˜¯ï¼Œå°†å›è°ƒæ·»åŠ åˆ°åˆ—è¡¨
3. å¦‚æœå¦ï¼Œåˆ›å»ºæ–°çš„ä¸‹è½½ä»»åŠ¡
4. ä¸‹è½½å®Œæˆåï¼Œé€šçŸ¥æ‰€æœ‰å›è°ƒ
```

### 3. å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Ÿ

```swift
// NSCache æœ¬èº«çº¿ç¨‹å®‰å…¨
// å­—å…¸éœ€è¦åŠ é”ä¿æŠ¤
private let lock = NSLock()

lock.lock()
// è®¿é—®å­—å…¸
lock.unlock()

// æˆ–ä½¿ç”¨ defer
lock.lock()
defer { lock.unlock() }
// è®¿é—®å­—å…¸
```

### 4. å¦‚ä½•å¤„ç†å†…å­˜è­¦å‘Šï¼Ÿ

```swift
// ç›‘å¬å†…å­˜è­¦å‘Šé€šçŸ¥
NotificationCenter.default.addObserver(
    self,
    selector: #selector(handleMemoryWarning),
    name: UIApplication.didReceiveMemoryWarningNotification,
    object: nil
)

@objc private func handleMemoryWarning() {
    // æ¸…ç©ºå†…å­˜ç¼“å­˜
    memoryCache.removeAllObjects()
    
    // ç£ç›˜ç¼“å­˜ä¸æ¸…ç†ï¼ˆæŒä¹…åŒ–ï¼‰
}
```

### 5. å¦‚ä½•å®ç° LRU ç­–ç•¥ï¼Ÿ

```swift
// NSCache å†…ç½® LRU ç­–ç•¥
// å½“è¾¾åˆ° countLimit æˆ– totalCostLimit æ—¶ï¼Œè‡ªåŠ¨ç§»é™¤æœ€ä¹…æœªä½¿ç”¨çš„å¯¹è±¡

// ç£ç›˜ç¼“å­˜è‡ªå·±å®ç° LRUï¼š
1. è®°å½•æ–‡ä»¶ä¿®æ”¹æ—¶é—´
2. è¶…è¿‡å¤§å°é™åˆ¶æ—¶ï¼ŒæŒ‰æ—¶é—´æ’åº
3. åˆ é™¤æœ€æ—§çš„æ–‡ä»¶

fileInfos.sort { $0.modificationDate < $1.modificationDate }
```

### 6. SDWebImage vs è‡ªå·±å®ç°ï¼Ÿ

```
SDWebImage ä¼˜åŠ¿ï¼š
âœ… åŠŸèƒ½å®Œå–„ï¼ˆåŠ¨å›¾ã€æ¸è¿›å¼åŠ è½½ç­‰ï¼‰
âœ… ç»è¿‡å¤§é‡é¡¹ç›®éªŒè¯
âœ… æŒç»­ç»´æŠ¤æ›´æ–°

è‡ªå·±å®ç°ä¼˜åŠ¿ï¼š
âœ… è½»é‡çº§ï¼Œå¯æ§æ€§å¼º
âœ… å­¦ä¹ æ¶æ„è®¾è®¡
âœ… å®šåˆ¶åŒ–éœ€æ±‚
âœ… é¢è¯•åŠ åˆ†

å®é™…é¡¹ç›®å»ºè®®ï¼šä½¿ç”¨æˆç†Ÿæ¡†æ¶
å­¦ä¹ é¡¹ç›®å»ºè®®ï¼šè‡ªå·±å®ç°
```

---

## ğŸš€ æ‰©å±•æ–¹å‘

### çŸ­æœŸæ‰©å±•

1. **åŠ¨å›¾æ”¯æŒï¼ˆGIF/APNGï¼‰**
   ```swift
   // ä½¿ç”¨ ImageIO è§£æåŠ¨å›¾
   // æ’­æ”¾åŠ¨å›¾å¸§åºåˆ—
   ```

2. **æ¸è¿›å¼åŠ è½½**
   ```swift
   // å…ˆæ˜¾ç¤ºæ¨¡ç³Šå›¾
   // é€æ­¥æ¸…æ™°åŒ–
   ```

3. **ä¸‹è½½è¿›åº¦**
   ```swift
   // URLSessionDownloadDelegate
   // æ˜¾ç¤ºä¸‹è½½ç™¾åˆ†æ¯”
   ```

### ä¸­æœŸæ‰©å±•

4. **WebP æ”¯æŒ**
   ```swift
   // é›†æˆ libwebp
   // WebP æ ¼å¼æ›´å°
   ```

5. **å›¾ç‰‡å¤„ç†**
   ```swift
   // åœ†è§’ã€æ»¤é•œã€è£å‰ª
   // ç¼“å­˜å¤„ç†åçš„å›¾ç‰‡
   ```

6. **é¢„åŠ è½½ç­–ç•¥**
   ```swift
   // æ™ºèƒ½é¢„æµ‹å³å°†æ˜¾ç¤ºçš„å›¾ç‰‡
   // æå‰ä¸‹è½½
   ```

### é•¿æœŸæ‰©å±•

7. **CDN ä¼˜åŒ–**
   ```swift
   // è‡ªåŠ¨é€‰æ‹©æœ€å¿«çš„ CDN èŠ‚ç‚¹
   // å¤±è´¥è‡ªåŠ¨åˆ‡æ¢å¤‡ç”¨èŠ‚ç‚¹
   ```

8. **äº‘ç«¯ç¼“å­˜åŒæ­¥**
   ```swift
   // iCloud åŒæ­¥ç¼“å­˜
   // å¤šè®¾å¤‡å…±äº«
   ```

---

## ğŸ” å¯¹æ¯”åˆ†æ

### vs SDWebImage

| ç‰¹æ€§ | æœ¬æ¡†æ¶ | SDWebImage |
|------|--------|------------|
| ä¸‰çº§ç¼“å­˜ | âœ… | âœ… |
| é˜²é‡å¤ä¸‹è½½ | âœ… | âœ… |
| åŠ¨å›¾æ”¯æŒ | âŒ | âœ… |
| WebP æ”¯æŒ | âŒ | âœ… |
| æ¸è¿›å¼åŠ è½½ | âŒ | âœ… |
| ä»£ç é‡ | ~500 è¡Œ | ~10000 è¡Œ |
| å­¦ä¹ æˆæœ¬ | ä½ | ä¸­ |

### vs Kingfisher (Swift)

| ç‰¹æ€§ | æœ¬æ¡†æ¶ | Kingfisher |
|------|--------|------------|
| è¯­è¨€ | Swift | Swift |
| å‡½æ•°å¼ç¼–ç¨‹ | éƒ¨åˆ† | âœ… |
| Combine æ”¯æŒ | âŒ | âœ… |
| SwiftUI æ”¯æŒ | âŒ | âœ… |
| å¤„ç†å™¨é“¾ | âŒ | âœ… |

---

## ğŸ’¡ æ€»ç»“

### å®ç°çš„åŠŸèƒ½

âœ… ä¸‰çº§ç¼“å­˜ï¼ˆå†…å­˜-ç£ç›˜-ç½‘ç»œï¼‰  
âœ… NSCache è‡ªåŠ¨å†…å­˜ç®¡ç†  
âœ… ç£ç›˜ç¼“å­˜è¿‡æœŸæ¸…ç†  
âœ… é˜²æ­¢é‡å¤ä¸‹è½½  
âœ… å¹¶å‘æ§åˆ¶  
âœ… è‡ªåŠ¨é‡è¯•  
âœ… Cell å¤ç”¨å®‰å…¨  
âœ… UIImageView ä¾¿æ·æ‰©å±•  
âœ… æ·¡å…¥åŠ¨ç”»  

### æŠ€æœ¯äº®ç‚¹

â­ å®Œæ•´çš„ä¸‰çº§ç¼“å­˜æ¶æ„  
â­ é«˜æ€§èƒ½å¼‚æ­¥æ“ä½œ  
â­ çº¿ç¨‹å®‰å…¨è®¾è®¡  
â­ æ™ºèƒ½ç¼“å­˜ç®¡ç†ç­–ç•¥  
â­ é˜²æ­¢ cell å¤ç”¨å›¾ç‰‡é”™ä¹±  
â­ å†…å­˜ç®¡ç†ä¼˜åŒ–  

### é¢è¯•ä»·å€¼

ğŸ¯ å±•ç¤ºæ¶æ„è®¾è®¡èƒ½åŠ›  
ğŸ¯ ç†è§£ç¼“å­˜ç­–ç•¥  
ğŸ¯ æŒæ¡å¤šçº¿ç¨‹ç¼–ç¨‹  
ğŸ¯ äº†è§£æ€§èƒ½ä¼˜åŒ–  
ğŸ¯ å®è·µè®¾è®¡æ¨¡å¼  

---

**å›¾ç‰‡åŠ è½½æ¡†æ¶æ˜¯ iOS é¢è¯•çš„é«˜é¢‘é¢˜ï¼ğŸ”¥**

