# æ¨¡å—é—´é€šä¿¡å®Œæ•´æ–¹æ¡ˆ

## ğŸ“Œ æ ¸å¿ƒç†å¿µ

åœ¨ Protocol-Based Router ä¸­ï¼Œ**æ¨¡å—é€šè¿‡ ModuleManagerï¼ˆä¸­ä»‹è€…ï¼‰è¿›è¡Œé€šä¿¡**ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¾èµ–å¯¹æ–¹ï¼Œå®ç°å®Œå…¨è§£è€¦ã€‚

---

## ğŸ’» é€šä¿¡æ–¹å¼

### æ–¹å¼ 1ï¼šé€šè¿‡ ModuleManager è°ƒç”¨æœåŠ¡ï¼ˆæ¨èâ­â­â­â­â­ï¼‰

è¿™æ˜¯**æœ€æ¨è**çš„æ–¹å¼ï¼Œé€šè¿‡ä¸­ä»‹è€…æ¨¡å¼ï¼Œæ¨¡å—é—´å®Œå…¨è§£è€¦ã€‚

#### åœºæ™¯ 1ï¼šProductModule è°ƒç”¨ UserModule æœåŠ¡

```swift
// ProductDetailViewController.swiftï¼ˆå•†å“è¯¦æƒ…é¡µï¼‰

class ProductDetailViewController: UIViewController {
    var productId: String?
    
    @IBAction func buyButtonTapped() {
        // 1. è·å– UserModule
        guard let userModule = ModuleManager.shared.module(UserModule.self) else {
            print("âŒ è·å– UserModule å¤±è´¥")
            return
        }
        
        // 2. æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆè°ƒç”¨ UserModule æœåŠ¡ï¼‰
        if let user = userModule.getCurrentUser() {
            // å·²ç™»å½•ï¼Œå¯ä»¥è´­ä¹°
            print("âœ… ç”¨æˆ·å·²ç™»å½•ï¼š\(user.name)")
            processPurchase()
        } else {
            // æœªç™»å½•ï¼Œè·³è½¬ç™»å½•é¡µ
            print("âš ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬ç™»å½•é¡µ")
            
            // 3. æ‰“å¼€ç™»å½•é¡µï¼ˆUserModule æä¾›çš„é¡µé¢ï¼‰
            ModuleManager.shared.openPage(
                UserModule.self,
                parameters: ["isLogin": true],
                from: self
            )
        }
    }
    
    private func processPurchase() {
        // è·å– ProductModuleï¼Œè°ƒç”¨è´­ä¹°æœåŠ¡
        if let productModule = ModuleManager.shared.module(ProductModule.self) {
            productModule.addToCart(productId: productId ?? "", quantity: 1)
            print("âœ… å·²æ·»åŠ åˆ°è´­ç‰©è½¦")
        }
    }
}
```

#### åœºæ™¯ 2ï¼šUserModule ç™»å½•åé€šçŸ¥ ProductModule

```swift
// ModuleLoginViewController.swiftï¼ˆç™»å½•é¡µï¼‰

class ModuleLoginViewController: UIViewController {
    
    @objc private func loginTapped() {
        let username = usernameTextField.text ?? ""
        let password = passwordTextField.text ?? ""
        
        // 1. è°ƒç”¨ UserModule ç™»å½•æœåŠ¡
        if let userModule = ModuleManager.shared.module(UserModule.self) {
            userModule.login(username: username, password: password) { [weak self] success, error in
                if success {
                    print("âœ… ç™»å½•æˆåŠŸ")
                    
                    // 2. ç™»å½•æˆåŠŸåï¼Œå¯ä»¥è°ƒç”¨å…¶ä»–æ¨¡å—æœåŠ¡
                    // ä¾‹å¦‚ï¼šåŒæ­¥è´­ç‰©è½¦
                    if let productModule = ModuleManager.shared.module(ProductModule.self) {
                        productModule.syncCart()
                    }
                    
                    // 3. è¿”å›ä¸Šä¸€é¡µ
                    self?.navigationController?.popViewController(animated: true)
                }
            }
        }
    }
}
```

---

### æ–¹å¼ 2ï¼šé€šè¿‡åè®®å®šä¹‰ä¾èµ–å…³ç³»

#### å®šä¹‰æ¨¡å—é—´ä¾èµ–åè®®

```swift
// ProductModuleProtocol.swift

protocol ProductModuleProtocol: PageModuleProtocol, ServiceModuleProtocol {
    // ... å•†å“ç›¸å…³æœåŠ¡
    
    /// è®¾ç½®ç”¨æˆ·æ¨¡å—ä¾èµ–ï¼ˆå¯é€‰ï¼‰
    var userModule: UserModuleProtocol? { get set }
}

// ProductModule.swift

class ProductModule: ProductModuleProtocol {
    static let moduleName = "ProductModule"
    
    // ä¾èµ–çš„å…¶ä»–æ¨¡å—ï¼ˆå¯é€‰ï¼‰
    var userModule: UserModuleProtocol?
    
    required init() {
        // è‡ªåŠ¨æ³¨å…¥ä¾èµ–ï¼ˆå¯é€‰ï¼‰
        self.userModule = ModuleManager.shared.module(UserModule.self)
    }
    
    func addToCart(productId: String, quantity: Int) -> Bool {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆä½¿ç”¨æ³¨å…¥çš„ userModuleï¼‰
        if let user = userModule?.getCurrentUser() {
            print("âœ… ç”¨æˆ· \(user.name) æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦")
            // æ·»åŠ åˆ°è´­ç‰©è½¦é€»è¾‘
            return true
        } else {
            print("âŒ ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•æ·»åŠ åˆ°è´­ç‰©è½¦")
            return false
        }
    }
}
```

---

### æ–¹å¼ 3ï¼šé€šè¿‡é€šçŸ¥ä¸­å¿ƒï¼ˆè§‚å¯Ÿè€…æ¨¡å¼ï¼‰

é€‚ç”¨äº**ä¸€å¯¹å¤š**çš„é€šä¿¡åœºæ™¯ã€‚

#### å®šä¹‰æ¨¡å—é€šçŸ¥

```swift
// ModuleNotification.swift

extension Notification.Name {
    // ç”¨æˆ·ç›¸å…³é€šçŸ¥
    static let userDidLogin = Notification.Name("userDidLogin")
    static let userDidLogout = Notification.Name("userDidLogout")
    static let userInfoDidUpdate = Notification.Name("userInfoDidUpdate")
    
    // å•†å“ç›¸å…³é€šçŸ¥
    static let productDidAddToCart = Notification.Name("productDidAddToCart")
    static let cartDidUpdate = Notification.Name("cartDidUpdate")
}

// é€šçŸ¥æ•°æ®
struct UserLoginNotification {
    let user: User
    let timestamp: Date
}
```

#### UserModule å‘é€é€šçŸ¥

```swift
// UserModule.swift

class UserModule: UserModuleProtocol {
    
    func login(username: String, password: String, completion: @escaping (Bool, String?) -> Void) {
        // ç™»å½•é€»è¾‘...
        
        if success {
            currentUser = user
            
            // å‘é€ç™»å½•æˆåŠŸé€šçŸ¥
            let userInfo = ["user": user, "timestamp": Date()] as [String: Any]
            NotificationCenter.default.post(
                name: .userDidLogin,
                object: nil,
                userInfo: userInfo
            )
            
            completion(true, nil)
        }
    }
    
    func logout() {
        currentUser = nil
        
        // å‘é€ç™»å‡ºé€šçŸ¥
        NotificationCenter.default.post(name: .userDidLogout, object: nil)
        
        print("ğŸ”“ å·²ç™»å‡º")
    }
}
```

#### ProductModule ç›‘å¬é€šçŸ¥

```swift
// ProductModule.swift

class ProductModule: ProductModuleProtocol {
    static let moduleName = "ProductModule"
    
    required init() {
        setupNotificationObservers()
    }
    
    private func setupNotificationObservers() {
        // ç›‘å¬ç”¨æˆ·ç™»å½•é€šçŸ¥
        NotificationCenter.default.addObserver(
            self,
            selector: #selector(handleUserLogin(_:)),
            name: .userDidLogin,
            object: nil
        )
        
        // ç›‘å¬ç”¨æˆ·ç™»å‡ºé€šçŸ¥
        NotificationCenter.default.addObserver(
            self,
            selector: #selector(handleUserLogout(_:)),
            name: .userDidLogout,
            object: nil
        )
    }
    
    @objc private func handleUserLogin(_ notification: Notification) {
        if let user = notification.userInfo?["user"] as? User {
            print("ğŸ“¦ ProductModule æ”¶åˆ°ç™»å½•é€šçŸ¥ï¼š\(user.name)")
            
            // åŒæ­¥è´­ç‰©è½¦
            syncCart()
        }
    }
    
    @objc private func handleUserLogout(_ notification: Notification) {
        print("ğŸ“¦ ProductModule æ”¶åˆ°ç™»å‡ºé€šçŸ¥")
        
        // æ¸…ç©ºè´­ç‰©è½¦
        clearCart()
    }
    
    deinit {
        NotificationCenter.default.removeObserver(self)
    }
}
```

---

### æ–¹å¼ 4ï¼šé€šè¿‡ EventBusï¼ˆå‘å¸ƒè®¢é˜…ï¼‰

å¦‚æœé¡¹ç›®ä¸­å·²ç»æœ‰ EventBusï¼Œå¯ä»¥ä½¿ç”¨å®ƒè¿›è¡Œæ¨¡å—é—´é€šä¿¡ã€‚

```swift
// å®šä¹‰äº‹ä»¶
struct UserLoginEvent {
    let user: User
    let loginTime: Date
}

struct CartUpdateEvent {
    let productId: String
    let quantity: Int
}

// UserModule å‘å¸ƒäº‹ä»¶
class UserModule: UserModuleProtocol {
    func login(username: String, password: String, completion: @escaping (Bool, String?) -> Void) {
        // ç™»å½•æˆåŠŸ
        if success {
            // å‘å¸ƒç™»å½•äº‹ä»¶
            EventBus.shared.post(UserLoginEvent(user: user, loginTime: Date()))
            completion(true, nil)
        }
    }
}

// ProductModule è®¢é˜…äº‹ä»¶
class ProductModule: ProductModuleProtocol {
    required init() {
        // è®¢é˜…ç”¨æˆ·ç™»å½•äº‹ä»¶
        EventBus.shared.subscribe(UserLoginEvent.self) { [weak self] event in
            print("ğŸ“¦ ProductModule æ”¶åˆ°ç™»å½•äº‹ä»¶ï¼š\(event.user.name)")
            self?.syncCart()
        }
    }
}
```

---

## ğŸ¯ å®Œæ•´é€šä¿¡ç¤ºä¾‹

### åœºæ™¯ï¼šå•†å“è¯¦æƒ…é¡µè´­ä¹°æµç¨‹

```swift
// 1. å•†å“è¯¦æƒ…é¡µï¼ˆProductDetailViewControllerï¼‰

class ProductDetailViewController: UIViewController {
    var productId: String = "8888"
    var product: Product?
    
    override func viewDidLoad() {
        super.viewDidLoad()
        loadProduct()
    }
    
    // åŠ è½½å•†å“ä¿¡æ¯
    private func loadProduct() {
        // è°ƒç”¨ ProductModule æœåŠ¡
        if let productModule = ModuleManager.shared.module(ProductModule.self) {
            productModule.getProduct(productId: productId) { [weak self] product in
                self?.product = product
                self?.updateUI()
            }
        }
    }
    
    // ç‚¹å‡»è´­ä¹°æŒ‰é’®
    @IBAction func buyButtonTapped() {
        // æ­¥éª¤1ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆè°ƒç”¨ UserModuleï¼‰
        checkLoginAndPurchase()
    }
    
    private func checkLoginAndPurchase() {
        // è·å– UserModule
        guard let userModule = ModuleManager.shared.module(UserModule.self) else {
            showAlert("ç³»ç»Ÿé”™è¯¯ï¼šæ— æ³•è·å–ç”¨æˆ·æ¨¡å—")
            return
        }
        
        // æ£€æŸ¥æ˜¯å¦ç™»å½•
        if let user = userModule.getCurrentUser() {
            // å·²ç™»å½•ï¼Œç»§ç»­è´­ä¹°æµç¨‹
            print("âœ… ç”¨æˆ·å·²ç™»å½•ï¼š\(user.name)")
            confirmPurchase(user: user)
        } else {
            // æœªç™»å½•ï¼Œè·³è½¬ç™»å½•é¡µ
            print("âš ï¸ ç”¨æˆ·æœªç™»å½•")
            openLoginPage()
        }
    }
    
    private func openLoginPage() {
        // æ‰“å¼€ç™»å½•é¡µï¼ˆUserModule æä¾›ï¼‰
        ModuleManager.shared.openPage(
            UserModule.self,
            parameters: ["isLogin": true],
            from: self
        )
    }
    
    private func confirmPurchase(user: User) {
        let alert = UIAlertController(
            title: "ç¡®è®¤è´­ä¹°",
            message: "ç¡®å®šè´­ä¹° \(product?.name ?? "") å—ï¼Ÿ",
            preferredStyle: .alert
        )
        
        alert.addAction(UIAlertAction(title: "å–æ¶ˆ", style: .cancel))
        alert.addAction(UIAlertAction(title: "ç¡®å®š", style: .default) { [weak self] _ in
            self?.processPurchase()
        })
        
        present(alert, animated: true)
    }
    
    private func processPurchase() {
        // æ­¥éª¤2ï¼šæ·»åŠ åˆ°è´­ç‰©è½¦ï¼ˆè°ƒç”¨ ProductModuleï¼‰
        guard let productModule = ModuleManager.shared.module(ProductModule.self) else {
            showAlert("ç³»ç»Ÿé”™è¯¯ï¼šæ— æ³•è·å–å•†å“æ¨¡å—")
            return
        }
        
        let success = productModule.addToCart(productId: productId, quantity: 1)
        
        if success {
            showAlert("âœ… å·²æ·»åŠ åˆ°è´­ç‰©è½¦") {
                // æ­¥éª¤3ï¼šè·³è½¬åˆ°è´­ç‰©è½¦é¡µé¢ï¼ˆå¯é€‰ï¼‰
                // è¿™é‡Œå¯ä»¥å†è°ƒç”¨ OrderModule ç­‰
            }
        } else {
            showAlert("âŒ æ·»åŠ å¤±è´¥")
        }
    }
    
    private func showAlert(_ message: String, completion: (() -> Void)? = nil) {
        let alert = UIAlertController(title: nil, message: message, preferredStyle: .alert)
        alert.addAction(UIAlertAction(title: "ç¡®å®š", style: .default) { _ in
            completion?()
        })
        present(alert, animated: true)
    }
}
```

### åœºæ™¯ï¼šç”¨æˆ·ç™»å½•ååŒæ­¥æ•°æ®

```swift
// 2. ç™»å½•é¡µï¼ˆModuleLoginViewControllerï¼‰

class ModuleLoginViewController: UIViewController {
    
    @objc private func loginTapped() {
        let username = usernameTextField.text ?? ""
        let password = passwordTextField.text ?? ""
        
        // è°ƒç”¨ UserModule ç™»å½•
        guard let userModule = ModuleManager.shared.module(UserModule.self) else {
            return
        }
        
        statusLabel.text = "ç™»å½•ä¸­..."
        
        userModule.login(username: username, password: password) { [weak self] success, error in
            if success {
                self?.statusLabel.text = "âœ… ç™»å½•æˆåŠŸ"
                
                // ç™»å½•æˆåŠŸåçš„æ“ä½œ
                self?.afterLoginSuccess()
                
                // 1ç§’åè¿”å›
                DispatchQueue.main.asyncAfter(deadline: .now() + 1) {
                    self?.navigationController?.popViewController(animated: true)
                }
            } else {
                self?.statusLabel.text = "âŒ \(error ?? "ç™»å½•å¤±è´¥")"
            }
        }
    }
    
    private func afterLoginSuccess() {
        // 1. åŒæ­¥è´­ç‰©è½¦ï¼ˆè°ƒç”¨ ProductModuleï¼‰
        if let productModule = ModuleManager.shared.module(ProductModule.self) {
            productModule.syncCart()
        }
        
        // 2. åŒæ­¥è®¢å•ï¼ˆè°ƒç”¨ OrderModuleï¼‰
        // if let orderModule = ModuleManager.shared.module(OrderModule.self) {
        //     orderModule.syncOrders()
        // }
        
        // 3. å‘é€é€šçŸ¥ï¼ˆé€šçŸ¥å…¶ä»–æ¨¡å—ï¼‰
        NotificationCenter.default.post(name: .userDidLogin, object: nil)
    }
}
```

---

## ğŸ”„ é€šä¿¡æµç¨‹å›¾

### åœºæ™¯ï¼šå•†å“è´­ä¹°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å•†å“è¯¦æƒ…é¡µ                        â”‚
â”‚    (ProductDetailViewController)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
         ç‚¹å‡» [è´­ä¹°] æŒ‰é’®
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    è·å– UserModule                        â”‚
â”‚    ModuleManager.shared.module(...)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
         æ£€æŸ¥ç™»å½•çŠ¶æ€
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                 â†“
    å·²ç™»å½•            æœªç™»å½•
        â†“                 â†“
    ç»§ç»­è´­ä¹°      æ‰“å¼€ç™»å½•é¡µ (UserModule)
        â†“                 â†“
    æ·»åŠ è´­ç‰©è½¦       ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
        â†“                 â†“
    è°ƒç”¨              è°ƒç”¨ UserModule.login()
ProductModule             â†“
    â†“                 ç™»å½•æˆåŠŸ
    â†“                 â†“
    â†“            å‘é€é€šçŸ¥/EventBus
    â†“                 â†“
    â†“            ProductModule åŒæ­¥æ•°æ®
    â†“                 â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
        è´­ä¹°å®Œæˆ
```

---

## ğŸ“Š æ–¹å¼å¯¹æ¯”

| é€šä¿¡æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|---------|
| **ModuleManager è°ƒç”¨** | âœ… ç±»å‹å®‰å…¨<br>âœ… ç¼–è¯‘æ£€æŸ¥<br>âœ… çµæ´» | âŒ éœ€è¦è·å–æ¨¡å—å®ä¾‹ | â­â­â­â­â­<br>æœ€æ¨èï¼Œæ‰€æœ‰åœºæ™¯ |
| **åè®®ä¾èµ–æ³¨å…¥** | âœ… æ›´æ¸…æ™°çš„ä¾èµ–å…³ç³»<br>âœ… æ˜“äºæµ‹è¯• | âŒ éœ€è¦æ˜¾å¼å£°æ˜ä¾èµ– | â­â­â­â­<br>å¤æ‚ä¾èµ–åœºæ™¯ |
| **NotificationCenter** | âœ… ä¸€å¯¹å¤šå¹¿æ’­<br>âœ… è§£è€¦ | âŒ æ— ç±»å‹å®‰å…¨<br>âŒ éš¾ä»¥è¿½è¸ª | â­â­â­<br>å¹¿æ’­é€šçŸ¥åœºæ™¯ |
| **EventBus** | âœ… ç±»å‹å®‰å…¨<br>âœ… ä¸€å¯¹å¤š | âŒ éœ€è¦å¼•å…¥ EventBus | â­â­â­â­<br>äº‹ä»¶é©±åŠ¨åœºæ™¯ |

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä¼˜å…ˆä½¿ç”¨ ModuleManagerï¼ˆæ¨èï¼‰

```swift
// âœ… æ¨èï¼šé€šè¿‡ ModuleManager è°ƒç”¨
if let userModule = ModuleManager.shared.module(UserModule.self) {
    let user = userModule.getCurrentUser()
}

// âŒ é¿å…ï¼šç›´æ¥ä¾èµ–æ¨¡å—
import UserModule  // ç´§è€¦åˆ
let user = UserManager.shared.getCurrentUser()
```

### 2. æœåŠ¡è°ƒç”¨ vs é€šçŸ¥

```swift
// æœåŠ¡è°ƒç”¨ï¼šéœ€è¦è¿”å›å€¼æˆ–åŒæ­¥æ“ä½œ
let user = userModule.getCurrentUser()  // âœ… ç«‹å³è¿”å›

// é€šçŸ¥ï¼šå¼‚æ­¥é€šçŸ¥ï¼Œä¸éœ€è¦è¿”å›å€¼
NotificationCenter.default.post(name: .userDidLogin, object: nil)  // âœ… å¹¿æ’­
```

### 3. é”™è¯¯å¤„ç†

```swift
// æ£€æŸ¥æ¨¡å—æ˜¯å¦å­˜åœ¨
guard let userModule = ModuleManager.shared.module(UserModule.self) else {
    print("âŒ UserModule æœªæ³¨å†Œ")
    return
}

// æ£€æŸ¥æœåŠ¡è¿”å›å€¼
if let user = userModule.getCurrentUser() {
    // å·²ç™»å½•
} else {
    // æœªç™»å½•
}
```

### 4. é¿å…å¾ªç¯ä¾èµ–

```swift
// âŒ é¿å…å¾ªç¯ä¾èµ–
UserModule â†’ ProductModule â†’ OrderModule â†’ UserModule  // å¾ªç¯

// âœ… å•å‘ä¾èµ–
UserModule â† ProductModule â† OrderModule  // å•å‘
```

---

## ğŸ¯ å®Œæ•´ä»£ç ç¤ºä¾‹

### ProductModule è°ƒç”¨ UserModule

```swift
// ProductModule.swift

class ProductModule: ProductModuleProtocol {
    static let moduleName = "ProductModule"
    
    required init() {}
    
    // æ·»åŠ åˆ°è´­ç‰©è½¦ï¼ˆéœ€è¦æ£€æŸ¥ç™»å½•ï¼‰
    func addToCart(productId: String, quantity: Int) -> Bool {
        // 1. è·å– UserModule
        guard let userModule = ModuleManager.shared.module(UserModule.self) else {
            print("âŒ æ— æ³•è·å– UserModule")
            return false
        }
        
        // 2. æ£€æŸ¥ç™»å½•çŠ¶æ€
        guard let user = userModule.getCurrentUser() else {
            print("âŒ ç”¨æˆ·æœªç™»å½•")
            return false
        }
        
        // 3. æ·»åŠ åˆ°è´­ç‰©è½¦
        print("âœ… ç”¨æˆ· \(user.name) æ·»åŠ å•†å“ \(productId) x\(quantity)")
        
        // 4. ä¿å­˜åˆ°æœ¬åœ°æˆ–æœåŠ¡å™¨
        // ...
        
        return true
    }
    
    // åŒæ­¥è´­ç‰©è½¦ï¼ˆç™»å½•åè°ƒç”¨ï¼‰
    func syncCart() {
        print("ğŸ”„ åŒæ­¥è´­ç‰©è½¦...")
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        if let userModule = ModuleManager.shared.module(UserModule.self),
           let user = userModule.getCurrentUser() {
            print("âœ… ä¸ºç”¨æˆ· \(user.name) åŒæ­¥è´­ç‰©è½¦")
            
            // ä»æœåŠ¡å™¨è·å–è´­ç‰©è½¦æ•°æ®
            // ...
        }
    }
}
```

### UserModule é€šçŸ¥å…¶ä»–æ¨¡å—

```swift
// UserModule.swift

class UserModule: UserModuleProtocol {
    static let moduleName = "UserModule"
    
    private var currentUser: User?
    
    required init() {}
    
    func login(username: String, password: String, completion: @escaping (Bool, String?) -> Void) {
        print("ğŸ” ç™»å½•ï¼š\(username)")
        
        // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
        DispatchQueue.main.asyncAfter(deadline: .now() + 1) { [weak self] in
            // ç™»å½•æˆåŠŸ
            self?.currentUser = User(
                id: "123",
                name: username,
                avatar: nil,
                email: "\(username)@example.com"
            )
            
            // é€šçŸ¥å…¶ä»–æ¨¡å—
            self?.notifyLoginSuccess()
            
            completion(true, nil)
        }
    }
    
    private func notifyLoginSuccess() {
        // æ–¹å¼1ï¼šé€šè¿‡é€šçŸ¥ä¸­å¿ƒ
        NotificationCenter.default.post(name: .userDidLogin, object: currentUser)
        
        // æ–¹å¼2ï¼šç›´æ¥è°ƒç”¨å…¶ä»–æ¨¡å—æœåŠ¡
        // åŒæ­¥è´­ç‰©è½¦
        if let productModule = ModuleManager.shared.module(ProductModule.self) {
            productModule.syncCart()
        }
        
        // åŒæ­¥è®¢å•
        // if let orderModule = ModuleManager.shared.module(OrderModule.self) {
        //     orderModule.syncOrders()
        // }
    }
    
    func logout() {
        currentUser = nil
        
        // é€šçŸ¥å…¶ä»–æ¨¡å—
        NotificationCenter.default.post(name: .userDidLogout, object: nil)
        
        // æ¸…ç©ºå…¶ä»–æ¨¡å—æ•°æ®
        if let productModule = ModuleManager.shared.module(ProductModule.self) {
            productModule.clearCart()
        }
        
        print("ğŸ”“ å·²ç™»å‡º")
    }
    
    func getCurrentUser() -> User? {
        return currentUser
    }
}
```

---

## âœ… æ€»ç»“

### æ¨¡å—é—´é€šä¿¡çš„æ ¸å¿ƒåŸåˆ™

1. **é€šè¿‡ ModuleManager è°ƒç”¨** - æœ€æ¨è â­â­â­â­â­
2. **åè®®å®šä¹‰æ¥å£** - ç±»å‹å®‰å…¨
3. **å•å‘ä¾èµ–** - é¿å…å¾ªç¯
4. **é€šçŸ¥å¹¿æ’­** - ä¸€å¯¹å¤šåœºæ™¯

### é€šä¿¡ç¤ºä¾‹

```swift
// ProductModule éœ€è¦ UserModule æœåŠ¡
if let userModule = ModuleManager.shared.module(UserModule.self) {
    if userModule.isLoggedIn() {
        // å·²ç™»å½•ï¼Œç»§ç»­æ“ä½œ
    } else {
        // æœªç™»å½•ï¼Œæ‰“å¼€ç™»å½•é¡µ
        ModuleManager.shared.openPage(UserModule.self, parameters: ["isLogin": true])
    }
}
```

### æ ¸å¿ƒä¼˜åŠ¿

âœ… **å®Œå…¨è§£è€¦** - æ¨¡å—é—´ä¸ç›´æ¥ä¾èµ–  
âœ… **ç±»å‹å®‰å…¨** - ç¼–è¯‘æ—¶æ£€æŸ¥  
âœ… **çµæ´»** - æ”¯æŒå¤šç§é€šä¿¡æ–¹å¼  
âœ… **æ˜“äºæµ‹è¯•** - å¯ Mock æ¨¡å—  

---

**æ¨¡å—é—´é€šä¿¡å·²å®Œæ•´å®ç°ï¼Œç«‹å³æµ‹è¯•è·¨æ¨¡å—åŠŸèƒ½ï¼ğŸš€**

