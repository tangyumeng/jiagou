# 通知路由快速测试指南 🔔

## ✅ 已完成的改动

### 1. Router.swift
- ✅ 添加 `setPendingRoute()` - 设置待处理路由
- ✅ 添加 `executePendingRoute()` - 执行待处理路由
- ✅ 添加 `hasPendingRoute` - 检查是否有待处理路由
- ✅ 添加 `clearPendingRoute()` - 清除待处理路由

### 2. AppDelegate.swift
- ✅ 导入 `UserNotifications`
- ✅ 请求通知权限
- ✅ 处理从通知启动的场景
- ✅ 实现 `UNUserNotificationCenterDelegate`
- ✅ 支持 URL Scheme 外部唤起

### 3. HomeViewController.swift
- ✅ 在 `viewDidAppear` 中执行延迟路由

### 4. RouterDemoViewController.swift
- ✅ 新增"通知路由测试"部分
- ✅ 添加"发送测试通知"按钮
- ✅ 实现本地通知测试功能

---

## 🚀 快速测试步骤

### 测试 1：App 在前台收到通知

```
1. 运行 App（⌘ + R）
2. 导航到：主页 → 路由框架
3. 点击 [发送测试通知（5秒后）]
4. 等待 5 秒，通知 banner 会出现
5. 点击通知 banner
6. ✅ 应该自动跳转到 VIP 页面
```

**控制台日志示例：**
```
[10:30:00] ✅ 通知已调度（5秒后触发）
[10:30:05] 🔔 前台收到通知
[10:30:05] 🔔 用户点击了通知
[10:30:05] 🚀 App 已运行，直接执行路由
[10:30:05] ✅ 路由匹配成功：app://vip/:vipId
[10:30:05] ✅ 跳转成功
```

---

### 测试 2：App 在后台

```
1. 运行 App
2. 导航到：主页 → 路由框架
3. 点击 [发送测试通知（5秒后）]
4. 立即按 Home 键（App 进入后台）
5. 等待通知出现
6. 点击通知
7. ✅ App 回到前台并跳转到 VIP 页面
```

**控制台日志示例：**
```
[10:30:00] ✅ 通知已调度（5秒后触发）
[10:30:05] 🔔 用户点击了通知
[10:30:05] 🚀 App 已运行，直接执行路由
[10:30:05] ✅ 跳转成功
```

---

### 测试 3：App 完全未启动（⭐ 核心测试）

```
1. 运行 App
2. 导航到：主页 → 路由框架
3. 点击 [发送测试通知（5秒后）]
4. 立即从多任务管理器完全杀死 App
   - 双击 Home 键（或上滑停留）
   - 向上滑动 App 卡片
5. 等待通知出现（5秒）
6. 点击通知
7. ✅ App 启动并自动跳转到 VIP 页面
```

**控制台日志示例：**
```
[启动] 🔔 用户点击了通知
[启动] 📦 通知内容：["route": "app://vip/999", ...]
[启动] 🔗 提取到路由：app://vip/999
[启动] 📌 App 正在启动，设置待处理路由
[启动] 📌 设置待处理路由：app://vip/999
[启动] ✅ 应用启动时已注册所有路由
[UI就绪] 🚀 HomeViewController 已就绪，执行待处理路由
[UI就绪] 🚀 执行待处理路由：app://vip/999
[0.5秒后] ✅ 路由匹配成功：app://vip/:vipId
[0.5秒后] ✅ 跳转成功
```

---

## 🎯 工作原理

### 场景分析

| 场景 | UI 状态 | 处理方式 |
|------|---------|---------|
| App 前台 | ✅ 已就绪 | 直接执行 `Router.open()` |
| App 后台 | ✅ 已就绪 | 直接执行 `Router.open()` |
| **App 未启动** | ❌ 未就绪 | `setPendingRoute()` → 延迟执行 |

### 生命周期时序

```
App 未启动时点击通知：

1. AppDelegate.didFinishLaunching
   ↓
   handleLaunchFromNotification
   ↓
   Router.setPendingRoute("app://vip/999") ✅
   
2. SceneDelegate.willConnectTo
   ↓
   创建 Window 和 RootViewController
   
3. HomeViewController.viewDidAppear
   ↓
   检查：Router.hasPendingRoute → true
   ↓
   Router.executePendingRoute() ✅
   ↓
   延迟 0.5 秒后执行路由 ✅
```

---

## 📋 通知负载格式

### 标准格式

```json
{
  "aps": {
    "alert": {
      "title": "路由测试通知",
      "body": "点击此通知将跳转到 VIP 页面"
    },
    "sound": "default",
    "badge": 1
  },
  "route": "app://vip/999",
  "parameters": {
    "from": "notification",
    "message": "通知路由测试成功！"
  }
}
```

### 关键字段

- **`route`**（必需）：路由 URL，例如 `app://product/123`
- **`parameters`**（可选）：额外参数，会合并到路由参数中

---

## 🔍 调试技巧

### 1. 查看所有已注册路由

在 Router 演示页面启动时，控制台会输出：

```
📊 已注册的路由（共 7 个）：
  - app://back [Push]
  - app://dismiss [Push]
  - app://user/:userId [Push]
  - app://settings [Present]
  - app://product/:productId [Push]
  - app://search [Push]
  - app://vip/:vipId [Push]
```

### 2. 跟踪路由执行

每个路由操作都有详细日志：

```
[10:30:05] 📤 打开：app://vip/999
[10:30:05] ✅ 路由匹配成功：app://vip/:vipId
[10:30:05] 📝 参数：["vipId": "999", "from": "notification"]
[10:30:05] 🔨 开始创建 ViewController...
[10:30:05] ✅ ViewController 创建成功：RouteVIPViewController
[10:30:05] ✅ 跳转成功
```

### 3. 检查待处理路由

```swift
// 在任何地方调用
if Router.shared.hasPendingRoute {
    print("有待处理的路由")
}
```

---

## 💡 实际应用场景

### 1. 推送通知跳转

```json
{
  "aps": {"alert": "您有新订单"},
  "route": "app://order/12345"
}
```

### 2. 外部 URL 唤起

```
myapp://product/123
```

### 3. 深度链接

```
https://yourapp.com/user/456
→ 转换为 app://user/456
```

### 4. 活动推广

```json
{
  "aps": {"alert": "限时优惠"},
  "route": "app://promotion/flash-sale"
}
```

---

## ⚠️ 注意事项

### 1. 通知权限

首次运行时会自动请求通知权限，如果用户拒绝：
- 去设置 → 你的 App → 通知 → 开启

### 2. 延迟执行

待处理路由会延迟 0.5 秒执行，确保 UI 完全就绪。

### 3. 路由未注册

如果通知中的路由未注册，会输出错误：

```
❌ 未找到匹配的路由：app://unknown/123
📋 当前已注册 7 个路由
```

### 4. 测试建议

- 每次测试前清空通知中心
- 测试完全杀死 App 时，等待通知完全出现后再点击
- 观察控制台日志，确认执行流程

---

## 📚 相关文档

- **详细设计文档**：`通知路由启动方案.md`
- **文件未添加问题**：`文件未添加到项目问题修复.md`
- **Router 演示说明**：`Router演示说明.md`

---

## ✅ 验证清单

测试完成后，请确认：

- [ ] 前台通知：点击 banner 能跳转 ✅
- [ ] 后台通知：从后台恢复并跳转 ✅
- [ ] 完全启动：杀死 App 后从通知启动并跳转 ✅
- [ ] 控制台日志正确输出 ✅
- [ ] 跳转到的页面参数正确 ✅

---

## 🎉 总结

通过这次改动，Router 框架现在支持：

✅ **延迟路由机制** - 等待 UI 就绪后执行  
✅ **通知唤起** - 从任何状态启动并跳转  
✅ **URL Scheme** - 外部应用唤起  
✅ **完整的生命周期处理** - 前台/后台/未启动  
✅ **测试工具** - 内置通知测试按钮  

**立即运行项目测试：主页 → 路由框架 → 发送测试通知！🚀**

