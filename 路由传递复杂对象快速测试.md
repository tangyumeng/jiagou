# è·¯ç”±ä¼ é€’å¤æ‚å¯¹è±¡ - å¿«é€Ÿæµ‹è¯•æŒ‡å—

## âœ… å·²å®Œæˆçš„æ”¹åŠ¨

### æ–°å¢æ–‡ä»¶

1. âœ… **RouteDataCache.swift** - å…¨å±€ç¼“å­˜ç®¡ç†å™¨
   - å­˜å‚¨å’Œè·å–å¤æ‚å¯¹è±¡
   - è‡ªåŠ¨è¿‡æœŸæ¸…ç†ï¼ˆTTLï¼‰
   - çº¿ç¨‹å®‰å…¨å®ç°

2. âœ… **RouteImagePreviewViewController** - å›¾ç‰‡é¢„è§ˆé¡µé¢
   - æ”¯æŒä¸¤ç§æ¥æ”¶æ–¹å¼ï¼šparameters å’Œç¼“å­˜ ID
   - æ˜¾ç¤ºå›¾ç‰‡å’Œå°ºå¯¸ä¿¡æ¯

### ä¿®æ”¹æ–‡ä»¶

1. âœ… **RoutePages.swift** - æ·»åŠ å›¾ç‰‡é¢„è§ˆé¡µé¢ç±»
2. âœ… **AppDelegate.swift** - æ³¨å†Œæ–°è·¯ç”±
3. âœ… **RouterDemoViewController.swift** - æ·»åŠ æµ‹è¯•æŒ‰é’®

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•

### æµ‹è¯• 1ï¼šæ–¹å¼1 - Parameters å­—å…¸ä¼ é€’ï¼ˆæ¨èï¼‰

```
1. è¿è¡Œ Appï¼ˆâŒ˜ + Rï¼‰
2. ä¸»é¡µ â†’ è·¯ç”±æ¡†æ¶
3. æ»šåŠ¨åˆ°åº•éƒ¨"ğŸ“¦ ä¼ é€’å¤æ‚å¯¹è±¡"éƒ¨åˆ†
4. ç‚¹å‡» [æ–¹å¼1ï¼šparameters å­—å…¸]
5. âœ… è¿›å…¥å›¾ç‰‡é¢„è§ˆé¡µï¼Œæ˜¾ç¤ºåŠ¨æ€ç”Ÿæˆçš„å›¾ç‰‡
```

**æ§åˆ¶å°æ—¥å¿—ï¼š**
```
[10:30:00] ğŸ“¤ æµ‹è¯•ä¼ é€’ UIImageï¼ˆæ–¹å¼1ï¼šparameters å­—å…¸ï¼‰
[10:30:00] ğŸ“¦ åˆ›å»ºå›¾ç‰‡ï¼š300Ã—200
[10:30:00] ğŸ“¤ é€šè¿‡ parameters ç›´æ¥ä¼ é€’ UIImage
[10:30:00] âœ… è·¯ç”±åŒ¹é…æˆåŠŸï¼šapp://image-preview
[10:30:00] ğŸ“ å‚æ•°ï¼š["image": <UIImage>, "title": "æ–¹å¼1ï¼šParameters"]
[10:30:00] âœ… è·³è½¬æˆåŠŸ
```

**ç‰¹ç‚¹ï¼š**
- âœ… ç›´æ¥ä¼ é€’ UIImage å¯¹è±¡
- âœ… æ— éœ€åºåˆ—åŒ–
- âœ… ç±»å‹å®‰å…¨
- âœ… æœ€ç®€å•ç›´æ¥

---

### æµ‹è¯• 2ï¼šæ–¹å¼2 - å…¨å±€ç¼“å­˜ + ID

```
1. è¿è¡Œ App
2. ä¸»é¡µ â†’ è·¯ç”±æ¡†æ¶
3. ç‚¹å‡» [æ–¹å¼2ï¼šå…¨å±€ç¼“å­˜ + ID]
4. âœ… è¿›å…¥å›¾ç‰‡é¢„è§ˆé¡µï¼Œæ˜¾ç¤ºä»ç¼“å­˜è·å–çš„å›¾ç‰‡
```

**æ§åˆ¶å°æ—¥å¿—ï¼š**
```
[10:30:00] ğŸ“¤ æµ‹è¯•ä¼ é€’ UIImageï¼ˆæ–¹å¼2ï¼šå…¨å±€ç¼“å­˜ï¼‰
[10:30:00] ğŸ“¦ åˆ›å»ºå›¾ç‰‡ï¼š300Ã—200
[10:30:00] ğŸ“¦ RouteDataCache: å­˜å‚¨å¯¹è±¡ [ABC-123] TTL=60ç§’
[10:30:00] ğŸ“¦ å­˜å‚¨åˆ°ç¼“å­˜ï¼šID = ABC-123
[10:30:00] ğŸ“¤ é€šè¿‡ URL ä¼ é€’ ID
[10:30:00] âœ… è·¯ç”±åŒ¹é…æˆåŠŸï¼šapp://image-preview/ABC-123
[10:30:00] ğŸ“¦ ä»ç¼“å­˜è·å–å›¾ç‰‡ï¼šæˆåŠŸ
[10:30:00] âœ… RouteDataCache: è·å–å¹¶ç§»é™¤å¯¹è±¡ [ABC-123]
[10:30:00] âœ… è·³è½¬æˆåŠŸ
```

**ç‰¹ç‚¹ï¼š**
- âœ… URL ç®€æ´ï¼ˆåªæœ‰ IDï¼‰
- âœ… æ”¯æŒå¤–éƒ¨å”¤èµ·
- âœ… è‡ªåŠ¨è¿‡æœŸæ¸…ç†
- âœ… é€‚åˆå¤§å¯¹è±¡

---

## ğŸ’¡ ä¸¤ç§æ–¹å¼å¯¹æ¯”

### ç•Œé¢å¯¹æ¯”

**æ–¹å¼1æ•ˆæœï¼š**
- å›¾ç‰‡ä¸Šæ˜¾ç¤ºï¼š"Hello Router!"
- é¡µé¢æ ‡é¢˜ï¼š"æ–¹å¼1ï¼šParameters"
- åº•éƒ¨æ˜¾ç¤ºï¼šå›¾ç‰‡å°ºå¯¸ 300 Ã— 200

**æ–¹å¼2æ•ˆæœï¼š**
- å›¾ç‰‡ä¸Šæ˜¾ç¤ºï¼š"Cache ID: 12345"
- é¡µé¢æ ‡é¢˜ï¼š"å›¾ç‰‡é¢„è§ˆ"
- åº•éƒ¨æ˜¾ç¤ºï¼šå›¾ç‰‡å°ºå¯¸ 300 Ã— 200

### æŠ€æœ¯å¯¹æ¯”

| ç‰¹æ€§ | æ–¹å¼1ï¼šParameters | æ–¹å¼2ï¼šç¼“å­˜+ID |
|------|------------------|---------------|
| ç®€æ´åº¦ | â­â­â­â­â­ | â­â­â­â­ |
| å¤–éƒ¨å”¤èµ· | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| é€šçŸ¥è·³è½¬ | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| ç±»å‹å®‰å…¨ | â­â­â­â­â­ | â­â­â­â­ |
| å†…å­˜ç®¡ç† | â­â­â­â­â­ | â­â­â­ (éœ€æ¸…ç†) |
| URL é•¿åº¦ | N/A | â­â­â­â­â­ |
| æ€§èƒ½ | â­â­â­â­â­ | â­â­â­â­ |

---

## ğŸ“Š ä»£ç è¯¦è§£

### æ–¹å¼1ï¼šParameters å­—å…¸

#### ä¼ é€’ä»£ç 

```swift
// åˆ›å»ºå¤æ‚å¯¹è±¡
let image = createTestImage(text: "Hello Router!", size: CGSize(width: 300, height: 200))

// ç›´æ¥é€šè¿‡ parameters ä¼ é€’
Router.shared.open(
    "app://image-preview",
    parameters: [
        "image": image,        // â† UIImage å¯¹è±¡
        "title": "æ–¹å¼1ï¼šParameters"
    ],
    from: self
)
```

#### æ¥æ”¶ä»£ç 

```swift
class RouteImagePreviewViewController: UIViewController, Routable {
    var image: UIImage?
    var imageTitle: String?
    
    static func instantiate(with parameters: [String : Any]) -> Self? {
        let vc = Self()
        
        // ä» parameters è·å– UIImage
        vc.image = parameters["image"] as? UIImage
        vc.imageTitle = parameters["title"] as? String
        
        return vc
    }
}
```

**å…³é”®ç‚¹ï¼š**
- `parameters` æ˜¯ `[String: Any]` å­—å…¸
- å¯ä»¥ä¼ é€’ä»»æ„ç±»å‹çš„å¯¹è±¡
- ç›´æ¥ä¼ é€’å¯¹è±¡å¼•ç”¨ï¼Œæ— éœ€åºåˆ—åŒ–

---

### æ–¹å¼2ï¼šå…¨å±€ç¼“å­˜ + ID

#### ä¼ é€’ä»£ç 

```swift
// åˆ›å»ºå¤æ‚å¯¹è±¡
let image = createTestImage(text: "Cache ID: 12345", size: CGSize(width: 300, height: 200))

// å­˜å‚¨åˆ°å…¨å±€ç¼“å­˜
let imageId = RouteDataCache.shared.storeImage(image, ttl: 60)
// è¿”å›: "ABC-123-XYZ"

// URL ä¸­åªä¼ é€’ ID
Router.shared.open("app://image-preview/\(imageId)", from: self)
// URL: "app://image-preview/ABC-123-XYZ"
```

#### æ¥æ”¶ä»£ç 

```swift
class RouteImagePreviewViewController: UIViewController, Routable {
    var imageId: String?
    var image: UIImage?
    
    static func instantiate(with parameters: [String : Any]) -> Self? {
        let vc = Self()
        
        // å¦‚æœæœ‰ imageIdï¼Œä»ç¼“å­˜è·å–
        if let imageId = parameters["imageId"] as? String {
            vc.image = RouteDataCache.shared.fetchImage(imageId)
            print("ğŸ“¦ ä»ç¼“å­˜è·å–å›¾ç‰‡ï¼š\(vc.image != nil ? "æˆåŠŸ" : "å¤±è´¥")")
        }
        
        return vc
    }
}
```

**å…³é”®ç‚¹ï¼š**
- ä½¿ç”¨ `RouteDataCache.shared.store()` å­˜å‚¨å¯¹è±¡
- è·å–å”¯ä¸€ ID
- URL ä¸­ä¼ é€’ ID
- ç›®æ ‡é¡µé¢é€šè¿‡ ID è·å–å¯¹è±¡
- `fetch()` ä¼šè‡ªåŠ¨ç§»é™¤ç¼“å­˜

---

## ğŸ” RouteDataCache è¯¦è§£

### æ ¸å¿ƒåŠŸèƒ½

```swift
class RouteDataCache {
    static let shared = RouteDataCache()
    
    // å­˜å‚¨å¯¹è±¡ï¼ˆè¿”å› IDï¼‰
    func store<T>(_ object: T, ttl: TimeInterval = 300) -> String
    
    // è·å–å¯¹è±¡ï¼ˆä¸ç§»é™¤ï¼‰
    func get<T>(_ id: String) -> T?
    
    // è·å–å¯¹è±¡å¹¶ç§»é™¤ï¼ˆæ¨èï¼‰
    func fetch<T>(_ id: String) -> T?
    
    // ç§»é™¤å¯¹è±¡
    func remove(_ id: String)
    
    // æ¸…ç©ºæ‰€æœ‰
    func removeAll()
}
```

### ç”Ÿå‘½å‘¨æœŸç®¡ç†

```swift
// 1. å­˜å‚¨æ—¶è®¾ç½® TTLï¼ˆç”Ÿå­˜æ—¶é—´ï¼‰
let id = RouteDataCache.shared.store(image, ttl: 60)  // 60ç§’åè¿‡æœŸ

// 2. ä½¿ç”¨åç«‹å³ç§»é™¤ï¼ˆæ¨èï¼‰
if let image: UIImage = RouteDataCache.shared.fetch(id) {
    // fetch() ä¼šè‡ªåŠ¨ç§»é™¤
    useImage(image)
}

// 3. å®šæ—¶æ¸…ç†ï¼ˆæ¯åˆ†é’Ÿè‡ªåŠ¨æ‰§è¡Œï¼‰
// è‡ªåŠ¨æ¸…ç†è¿‡æœŸå¯¹è±¡
```

### çº¿ç¨‹å®‰å…¨

```swift
// ä½¿ç”¨å¹¶å‘é˜Ÿåˆ— + barrier æ ‡å¿—
private let queue = DispatchQueue(label: "...", attributes: .concurrent)

// è¯»æ“ä½œï¼ˆå¹¶å‘ï¼‰
func get<T>(_ id: String) -> T? {
    queue.sync { /* è¯»å– */ }
}

// å†™æ“ä½œï¼ˆç‹¬å ï¼‰
func store<T>(_ object: T) -> String {
    queue.async(flags: .barrier) { /* å†™å…¥ */ }
}
```

---

## ğŸ“± å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šå›¾ç‰‡é€‰æ‹©å™¨

```swift
// æ‰“å¼€å›¾ç‰‡é€‰æ‹©å™¨
Router.shared.open(
    "app://image-picker",
    parameters: [
        "onSelected": { (image: UIImage) in
            print("ç”¨æˆ·é€‰æ‹©äº†å›¾ç‰‡")
            self.selectedImage = image
        }
    ]
)

// ImagePickerViewController
var onSelected: ((UIImage) -> Void)?

func imagePickerController(...) {
    if let image = ... {
        onSelected?(image)  // å›è°ƒ
        dismiss(animated: true)
    }
}
```

### åœºæ™¯ 2ï¼šä»é€šçŸ¥é¢„è§ˆå›¾ç‰‡

```swift
// æ”¶åˆ°é€šçŸ¥æ—¶
func didReceiveNotification(imageUrl: String) {
    // 1. ä¸‹è½½å›¾ç‰‡
    downloadImage(imageUrl) { image in
        // 2. å­˜å‚¨åˆ°ç¼“å­˜
        let imageId = RouteDataCache.shared.store(image)
        
        // 3. å‘é€æœ¬åœ°é€šçŸ¥
        let content = UNMutableNotificationContent()
        content.userInfo = [
            "route": "app://image-preview/\(imageId)"
        ]
        // ...
    }
}

// ç”¨æˆ·ç‚¹å‡»é€šçŸ¥
// â†’ App å¯åŠ¨
// â†’ Router æå– imageId
// â†’ ä»ç¼“å­˜è·å–å›¾ç‰‡
// â†’ æ˜¾ç¤ºå›¾ç‰‡
```

### åœºæ™¯ 3ï¼šä¼ é€’è‡ªå®šä¹‰å¯¹è±¡

```swift
// å®šä¹‰æ•°æ®æ¨¡å‹
struct ProductData {
    let id: Int
    let name: String
    let price: Double
}

// ä¼ é€’æ•°æ® + å›¾ç‰‡
let product = ProductData(id: 1, name: "iPhone", price: 5999)
let image = UIImage(named: "iphone")!

Router.shared.open(
    "app://product-detail",
    parameters: [
        "product": product,  // è‡ªå®šä¹‰å¯¹è±¡
        "image": image       // UIImage
    ]
)
```

### åœºæ™¯ 4ï¼šä¼ é€’ NSData

```swift
// ä¼ é€’æ–‡ä»¶æ•°æ®
let fileData = try! Data(contentsOf: fileURL)

Router.shared.open(
    "app://file-preview",
    parameters: [
        "data": fileData,
        "filename": "document.pdf"
    ]
)
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å†…å­˜ç®¡ç†

```swift
// âœ… æ¨èï¼šä½¿ç”¨ fetch()ï¼ˆä¼šè‡ªåŠ¨ç§»é™¤ï¼‰
if let image = RouteDataCache.shared.fetch(id) {
    use(image)
}

// âŒ é¿å…ï¼šåªç”¨ get()ï¼ˆä¸ä¼šç§»é™¤ï¼‰
if let image = RouteDataCache.shared.get(id) {
    use(image)
    // éœ€è¦æ‰‹åŠ¨ç§»é™¤
    RouteDataCache.shared.remove(id)
}
```

### 2. TTL è®¾ç½®

```swift
// æ ¹æ®åœºæ™¯è®¾ç½®åˆé€‚çš„ TTL

// ä¸´æ—¶æ•°æ®ï¼ˆ1åˆ†é’Ÿï¼‰
RouteDataCache.shared.store(tempData, ttl: 60)

// é¡µé¢è·³è½¬ï¼ˆ5åˆ†é’Ÿï¼Œé»˜è®¤ï¼‰
RouteDataCache.shared.store(image, ttl: 300)

// é•¿æœŸç¼“å­˜ï¼ˆ30åˆ†é’Ÿï¼‰
RouteDataCache.shared.store(largeData, ttl: 1800)
```

### 3. ç±»å‹å®‰å…¨

```swift
// âœ… æ¨èï¼šæŒ‡å®šç±»å‹
let image: UIImage? = RouteDataCache.shared.fetch(id)

// âŒ é¿å…ï¼šä½¿ç”¨ Any
let object: Any? = RouteDataCache.shared.fetch(id)
```

### 4. å¾ªç¯å¼•ç”¨

```swift
// âŒ å¯èƒ½å¯¼è‡´å¾ªç¯å¼•ç”¨
Router.shared.open("...", parameters: [
    "callback": { self.doSomething() }  // æŒæœ‰ self
])

// âœ… ä½¿ç”¨ weak self
Router.shared.open("...", parameters: [
    "callback": { [weak self] in self?.doSomething() }
])
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### é€‰æ‹©æ–¹æ¡ˆ

```
éœ€è¦ä¼ é€’å¤æ‚å¯¹è±¡ï¼Ÿ
  â†“
åº”ç”¨å†…è·³è½¬ï¼Ÿ
  â†“ æ˜¯
  ä½¿ç”¨æ–¹å¼1ï¼šparameters å­—å…¸ â­â­â­â­â­
  - ç®€å•ç›´æ¥
  - ç±»å‹å®‰å…¨
  - æ— éœ€ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
  
  â†“ å¦ï¼ˆå¤–éƒ¨å”¤èµ·ã€é€šçŸ¥ï¼‰
  ä½¿ç”¨æ–¹å¼2ï¼šå…¨å±€ç¼“å­˜ + ID â­â­â­â­
  - æ”¯æŒå¤–éƒ¨å”¤èµ·
  - URL ç®€æ´
  - æå‰å‡†å¤‡æ•°æ®
```

### ä»£ç é£æ ¼

```swift
// âœ… å¥½ï¼šæ¸…æ™°çš„å‚æ•°å
Router.shared.open(
    "app://image-preview",
    parameters: [
        "image": myImage,
        "title": "æˆ‘çš„ç…§ç‰‡"
    ]
)

// âŒ å·®ï¼šå«ç³Šçš„å‚æ•°å
Router.shared.open(
    "app://image-preview",
    parameters: [
        "data": myImage,
        "str": "æˆ‘çš„ç…§ç‰‡"
    ]
)
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **è·¯ç”±ä¼ é€’å¤æ‚å¯¹è±¡æ–¹æ¡ˆ.md** - å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆ
- **Routeræ¼”ç¤ºè¯´æ˜.md** - åŸºç¡€è·¯ç”±ä½¿ç”¨
- **é€šçŸ¥è·¯ç”±å¯åŠ¨æ–¹æ¡ˆ.md** - ä»é€šçŸ¥å¯åŠ¨

---

## âœ… éªŒè¯æ¸…å•

æµ‹è¯•å®Œæˆåï¼Œè¯·ç¡®è®¤ï¼š

- [ ] æ–¹å¼1ï¼ˆparametersï¼‰èƒ½æ­£å¸¸ä¼ é€’å›¾ç‰‡ âœ…
- [ ] æ–¹å¼2ï¼ˆç¼“å­˜ï¼‰èƒ½æ­£å¸¸ä¼ é€’å›¾ç‰‡ âœ…
- [ ] å›¾ç‰‡åœ¨é¢„è§ˆé¡µæ­£ç¡®æ˜¾ç¤º âœ…
- [ ] æ§åˆ¶å°æ—¥å¿—æ­£ç¡®è¾“å‡º âœ…
- [ ] ç¼“å­˜è‡ªåŠ¨æ¸…ç†å·¥ä½œæ­£å¸¸ âœ…

---

## ğŸ‰ æ€»ç»“

### å®ç°çš„åŠŸèƒ½

âœ… **æ–¹å¼1ï¼šParameters** - ç›´æ¥ä¼ é€’å¯¹è±¡  
âœ… **æ–¹å¼2ï¼šç¼“å­˜+ID** - æ”¯æŒå¤–éƒ¨å”¤èµ·  
âœ… **RouteDataCache** - å…¨å±€ç¼“å­˜ç®¡ç†  
âœ… **è‡ªåŠ¨æ¸…ç†** - TTL è¿‡æœŸæœºåˆ¶  
âœ… **çº¿ç¨‹å®‰å…¨** - å¹¶å‘é˜Ÿåˆ—ä¿æŠ¤  
âœ… **æµ‹è¯•å·¥å…·** - å®Œæ•´ç¤ºä¾‹ä»£ç   

### æŠ€æœ¯ä»·å€¼

ğŸ¯ **è§£å†³å®é™…é—®é¢˜** - UIImageã€NSData ä¼ é€’  
ğŸ¯ **ä¸¤ç§æ–¹æ¡ˆ** - åº”ç”¨å†… + å¤–éƒ¨å”¤èµ·  
ğŸ¯ **ç”Ÿäº§çº§ä»£ç ** - çº¿ç¨‹å®‰å…¨ã€å†…å­˜ç®¡ç†  
ğŸ¯ **é¢è¯•ä»·å€¼** - ç¼“å­˜è®¾è®¡ã€è·¯ç”±è§£è€¦  

---

**ç«‹å³è¿è¡Œé¡¹ç›®æµ‹è¯•ä¸¤ç§ä¼ é€’æ–¹å¼ï¼ğŸ“±**

**ä¸»é¡µ â†’ è·¯ç”±æ¡†æ¶ â†’ æ»šåŠ¨åˆ°åº•éƒ¨ â†’ ç‚¹å‡»æµ‹è¯•æŒ‰é’®ï¼ğŸš€**

