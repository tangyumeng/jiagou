# æ¨¡å—é—´é€šä¿¡ç»ˆææ–¹æ¡ˆ

## ğŸ“Œ é—®é¢˜å›ç­”

**Q: ProductModule å’Œ UserModule ä¸¤ä¸ªæ¨¡å—æ€æ ·é€šä¿¡ï¼Ÿ**

**A: é€šè¿‡ `ModuleManager.shared.module(åè®®ç±»å‹.self)` è·å–å¯¹æ–¹æ¨¡å—ï¼Œç„¶åè°ƒç”¨åè®®æ–¹æ³•ã€‚**

---

## ğŸ¯ æ ¸å¿ƒç­”æ¡ˆ

### ç®€å•ç‰ˆç­”æ¡ˆ

```swift
// ProductModule ä¸­è°ƒç”¨ UserModule æœåŠ¡

// âœ… é€šè¿‡åè®®ç±»å‹è·å–æ¨¡å—ï¼ˆæ— éœ€ import UserModuleï¼‰
let userModule = ModuleManager.shared.module(UserModuleProtocol.self)

// è°ƒç”¨æœåŠ¡
if let user = userModule?.getCurrentUser() {
    print("å½“å‰ç”¨æˆ·ï¼š\(user.name)")
}
```

### å®Œæ•´ç‰ˆç­”æ¡ˆ

åœ¨ CocoaPods ç»„ä»¶åŒ–æ¶æ„ä¸­ï¼š

```
1. åˆ›å»ºåè®®å±‚ Podï¼ˆModuleProtocolsï¼‰
   - å®šä¹‰ UserModuleProtocol
   - å®šä¹‰ ProductModuleProtocol
   - å®šä¹‰æ•°æ®æ¨¡å‹ï¼ˆUser, Productï¼‰

2. UserModule Pod å’Œ ProductModule Pod
   - éƒ½åªä¾èµ– ModuleProtocols Pod
   - äº’ä¸ä¾èµ–

3. é€šä¿¡æ–¹å¼ï¼š
   - é€šè¿‡åè®®ç±»å‹è·å–å¯¹æ–¹æ¨¡å—
   - è°ƒç”¨åè®®å®šä¹‰çš„æ–¹æ³•
   - å®Œå…¨è§£è€¦
```

---

## ğŸ’» ä»£ç å®ç°

### 1. åè®®å±‚ï¼ˆModuleProtocols Podï¼‰

```swift
// ModuleProtocols/Protocols/UserModuleProtocol.swift

import UIKit

public protocol UserModuleProtocol: ModuleProtocol {
    func getCurrentUser() -> User?
    func isLoggedIn() -> Bool
    func login(username: String, password: String, completion: @escaping (Bool, String?) -> Void)
    func logout()
}
```

```swift
// ModuleProtocols/Protocols/ProductModuleProtocol.swift

import UIKit

public protocol ProductModuleProtocol: ModuleProtocol {
    func getProduct(productId: String, completion: @escaping (Product?) -> Void)
    func addToCart(productId: String, quantity: Int) -> Bool
    func syncCart()
    func clearCart()
}
```

---

### 2. ProductModule è°ƒç”¨ UserModuleï¼ˆæ— éœ€å¯¼å…¥ï¼‰

```swift
// ProductModule/ProductModule.swift

import ModuleProtocols  // âœ… åªä¾èµ–åè®®å±‚

class ProductModule: ProductModuleProtocol {
    static let moduleName = "ProductModule"
    
    required init() {}
    
    func addToCart(productId: String, quantity: Int) -> Bool {
        // âœ… é€šè¿‡åè®®ç±»å‹è·å– UserModuleï¼ˆä¸éœ€è¦ import UserModuleï¼‰
        guard let userModule = ModuleManager.shared.module(UserModuleProtocol.self) else {
            print("âŒ æ— æ³•è·å– UserModule")
            return false
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        guard let user = userModule.getCurrentUser() else {
            print("âŒ ç”¨æˆ·æœªç™»å½•")
            return false
        }
        
        // æ·»åŠ åˆ°è´­ç‰©è½¦
        print("âœ… ç”¨æˆ· \(user.name) æ·»åŠ å•†å“")
        return true
    }
    
    func syncCart() {
        // âœ… åŒæ ·é€šè¿‡åè®®ç±»å‹
        guard let userModule = ModuleManager.shared.module(UserModuleProtocol.self) else {
            return
        }
        
        if let user = userModule.getCurrentUser() {
            print("ğŸ”„ ä¸ºç”¨æˆ· \(user.name) åŒæ­¥è´­ç‰©è½¦")
            // ç½‘ç»œè¯·æ±‚åŒæ­¥è´­ç‰©è½¦...
        }
    }
}
```

**ä¾èµ–å…³ç³»ï¼š**
```
ProductModule.podspec:
  s.dependency 'ModuleProtocols'  âœ… åªä¾èµ–åè®®å±‚
  # s.dependency 'UserModule'  âŒ ä¸ä¾èµ– UserModule
```

---

### 3. UserModule è°ƒç”¨ ProductModuleï¼ˆæ— éœ€å¯¼å…¥ï¼‰

```swift
// UserModule/UserModule.swift

import ModuleProtocols  // âœ… åªä¾èµ–åè®®å±‚

class UserModule: UserModuleProtocol {
    static let moduleName = "UserModule"
    
    private var currentUser: User?
    
    required init() {}
    
    func login(username: String, password: String, completion: @escaping (Bool, String?) -> Void) {
        // ç™»å½•é€»è¾‘...
        currentUser = User(id: "123", name: username)
        
        // ç™»å½•æˆåŠŸåï¼Œé€šçŸ¥å…¶ä»–æ¨¡å—
        notifyOtherModulesAfterLogin()
        
        completion(true, nil)
    }
    
    func logout() {
        currentUser = nil
        
        // ç™»å‡ºåï¼Œé€šçŸ¥å…¶ä»–æ¨¡å—
        notifyOtherModulesAfterLogout()
    }
    
    private func notifyOtherModulesAfterLogin() {
        // âœ… é€šè¿‡åè®®ç±»å‹è·å– ProductModuleï¼ˆä¸éœ€è¦ import ProductModuleï¼‰
        if let productModule = ModuleManager.shared.module(ProductModuleProtocol.self) {
            print("ğŸ”„ UserModule: é€šçŸ¥ ProductModule åŒæ­¥è´­ç‰©è½¦")
            productModule.syncCart()
        }
    }
    
    private func notifyOtherModulesAfterLogout() {
        // âœ… é€šè¿‡åè®®ç±»å‹è·å– ProductModule
        if let productModule = ModuleManager.shared.module(ProductModuleProtocol.self) {
            print("ğŸ—‘ï¸ UserModule: é€šçŸ¥ ProductModule æ¸…ç©ºè´­ç‰©è½¦")
            productModule.clearCart()
        }
    }
}
```

**ä¾èµ–å…³ç³»ï¼š**
```
UserModule.podspec:
  s.dependency 'ModuleProtocols'  âœ… åªä¾èµ–åè®®å±‚
  # s.dependency 'ProductModule'  âŒ ä¸ä¾èµ– ProductModule
```

---

## ğŸ” ä¸ºä»€ä¹ˆä¸éœ€è¦ importï¼Ÿ

### ä¼ ç»Ÿæ–¹å¼ï¼ˆâŒ éœ€è¦å¯¼å…¥ï¼‰

```swift
// ProductModule.swift

import UserModule  // âŒ éœ€è¦å¯¼å…¥å…·ä½“æ¨¡å—

func addToCart() {
    let userModule = UserModule.shared  // ä½¿ç”¨å…·ä½“ç±»
    let user = userModule.getCurrentUser()
}
```

### åè®®å±‚æ–¹å¼ï¼ˆâœ… æ— éœ€å¯¼å…¥ï¼‰

```swift
// ProductModule.swift

import ModuleProtocols  // âœ… åªå¯¼å…¥åè®®å±‚ï¼ˆå·²ç»åŒ…å« UserModuleProtocolï¼‰

func addToCart() {
    // ä½¿ç”¨åè®®ç±»å‹ï¼ˆåœ¨ ModuleProtocols ä¸­å®šä¹‰ï¼‰
    let userModule = ModuleManager.shared.module(UserModuleProtocol.self)
    let user = userModule?.getCurrentUser()
}
```

**å…³é”®ï¼š**
- `UserModuleProtocol` å®šä¹‰åœ¨ `ModuleProtocols` ä¸­
- `ProductModule` å¯¼å…¥äº† `ModuleProtocols`ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ `UserModuleProtocol`
- ä¸éœ€è¦å¯¼å…¥ `UserModule`ï¼ˆå…·ä½“å®ç°ï¼‰

---

## ğŸ“Š é€šä¿¡æµç¨‹å›¾

### åœºæ™¯ï¼šå•†å“è´­ä¹°æµç¨‹ï¼ˆè·¨æ¨¡å—ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ProductDetailViewController      â”‚
â”‚   (å•†å“è¯¦æƒ…é¡µ)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ ç”¨æˆ·ç‚¹å‡»è´­ä¹°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ProductModule.addToCart()        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ModuleManager.shared.module(     â”‚
â”‚     UserModuleProtocol.self        â”‚ â† é€šè¿‡åè®®ç±»å‹è·å–
â”‚   )                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ModuleManager æŸ¥æ‰¾:               â”‚
â”‚   å“ªä¸ªæ¨¡å—å®ç°äº† UserModuleProtocol?â”‚
â”‚   â†’ æ‰¾åˆ° UserModule                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   UserModule å®ä¾‹                  â”‚
â”‚   (ä½œä¸º UserModuleProtocol ç±»å‹)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è°ƒç”¨åè®®æ–¹æ³•ï¼š                    â”‚
â”‚   userModule.getCurrentUser()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¿”å› User å¯¹è±¡                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ åŒå‘é€šä¿¡ç¤ºä¾‹

### ProductModule â‡„ UserModule

```swift
// æ–¹å‘1ï¼šProductModule â†’ UserModule
class ProductModule {
    func addToCart(productId: String, quantity: Int) -> Bool {
        // è·å– UserModuleï¼ˆé€šè¿‡åè®®ï¼‰
        let userModule = ModuleManager.shared.module(UserModuleProtocol.self)
        
        // è°ƒç”¨ UserModule æœåŠ¡
        if let user = userModule?.getCurrentUser() {
            print("ç”¨æˆ· \(user.name) æ·»åŠ å•†å“")
            return true
        }
        return false
    }
}

// æ–¹å‘2ï¼šUserModule â†’ ProductModule
class UserModule {
    func login(...) {
        // ç™»å½•æˆåŠŸ
        
        // è·å– ProductModuleï¼ˆé€šè¿‡åè®®ï¼‰
        let productModule = ModuleManager.shared.module(ProductModuleProtocol.self)
        
        // è°ƒç”¨ ProductModule æœåŠ¡
        productModule?.syncCart()
    }
}
```

**å…³é”®ï¼š**
- åŒæ–¹éƒ½é€šè¿‡åè®®ç±»å‹è°ƒç”¨
- åŒæ–¹éƒ½æ— éœ€ import å¯¹æ–¹
- å®Œå…¨è§£è€¦

---

## âœ… é¡¹ç›®ä¾èµ–å…³ç³»

### Podfile

```ruby
target 'MyApp' do
  # åè®®å±‚
  pod 'ModuleProtocols'
  
  # ä¸šåŠ¡æ¨¡å—
  pod 'UserModule'
  pod 'ProductModule'
end
```

### å„ Pod çš„ä¾èµ–

```
ModuleProtocols.podspec:
  # ä¸ä¾èµ–ä»»ä½•ä¸šåŠ¡æ¨¡å—

UserModule.podspec:
  s.dependency 'ModuleProtocols'  # âœ… åªä¾èµ–åè®®å±‚

ProductModule.podspec:
  s.dependency 'ModuleProtocols'  # âœ… åªä¾èµ–åè®®å±‚
```

### Import è¯­å¥

```swift
// UserModule/UserModule.swift
import ModuleProtocols  // âœ… å¯ä»¥ä½¿ç”¨ ProductModuleProtocol

// ProductModule/ProductModule.swift
import ModuleProtocols  // âœ… å¯ä»¥ä½¿ç”¨ UserModuleProtocol

// æ³¨æ„ï¼šä¸éœ€è¦ import å¯¹æ–¹ï¼
```

---

## ğŸ¯ å®æˆ˜æµ‹è¯•

### æµ‹è¯•ç™»å½•ååŒæ­¥è´­ç‰©è½¦

```
1. è¿è¡Œ Appï¼ˆâŒ˜ + Rï¼‰
2. ä¸»é¡µ â†’ åè®®è·¯ç”±ï¼ˆæ¨¡å—åŒ–ï¼‰
3. ç‚¹å‡» [è°ƒç”¨ç™»å½•æœåŠ¡]
4. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼š

æ§åˆ¶å°è¾“å‡ºï¼š
[10:30:00] ğŸ“¤ è°ƒç”¨ç™»å½•æœåŠ¡ï¼ˆUserModuleï¼‰
[10:30:00] ğŸ” ç™»å½•ï¼šzhangsan
[10:30:01] ğŸ”„ UserModule: é€šçŸ¥å…¶ä»–æ¨¡å—åŒæ­¥æ•°æ®
[10:30:01] ğŸ”„ UserModule: é€šçŸ¥ ProductModule åŒæ­¥è´­ç‰©è½¦
[10:30:01] ğŸ”„ åŒæ­¥è´­ç‰©è½¦...
[10:30:01] âœ… ä¸ºç”¨æˆ· zhangsan åŒæ­¥è´­ç‰©è½¦
[10:30:01] âœ… ç™»å½•æˆåŠŸ
```

### æµ‹è¯•æ·»åŠ è´­ç‰©è½¦ï¼ˆæ£€æŸ¥ç™»å½•ï¼‰

```
1. ç‚¹å‡» [æ‰“å¼€å•†å“è¯¦æƒ…é¡µ]
2. è¿›å…¥å•†å“è¯¦æƒ…é¡µ
3. ç‚¹å‡» [åŠ å…¥è´­ç‰©è½¦]

å¦‚æœå·²ç™»å½•ï¼š
âœ… å·²æ·»åŠ åˆ°è´­ç‰©è½¦

å¦‚æœæœªç™»å½•ï¼š
âŒ ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•æ·»åŠ åˆ°è´­ç‰©è½¦
```

---

## ğŸ“š å…³é”®ä»£ç æ±‡æ€»

### ModuleManager æ ¸å¿ƒæ–¹æ³•

```swift
// æ”¯æŒé€šè¿‡åè®®ç±»å‹è·å–æ¨¡å—
func module<T: ModuleProtocol>(_ type: T.Type) -> T? {
    // éå†æ‰€æœ‰æ³¨å†Œçš„æ¨¡å—
    for (_, moduleType) in modules {
        // æ£€æŸ¥æ˜¯å¦å®ç°äº†è¯¥åè®®
        if let matchedType = moduleType as? T.Type {
            return matchedType.init()
        }
    }
    return nil
}
```

### ProductModule è°ƒç”¨ UserModule

```swift
// âœ… æ— éœ€ import UserModule
let userModule = ModuleManager.shared.module(UserModuleProtocol.self)
let user = userModule?.getCurrentUser()
```

### UserModule è°ƒç”¨ ProductModule

```swift
// âœ… æ— éœ€ import ProductModule
let productModule = ModuleManager.shared.module(ProductModuleProtocol.self)
productModule?.syncCart()
```

---

## âœ… æ€»ç»“

### æ ¸å¿ƒæœºåˆ¶

**é€šè¿‡åè®®å±‚ï¼ˆModuleProtocolsï¼‰ä½œä¸ºä¸­é—´å±‚ï¼Œå®ç°æ¨¡å—é—´å®Œå…¨è§£è€¦é€šä¿¡**

### ä¾èµ–å…³ç³»

```
         ModuleProtocols Pod
               â†™        â†˜
    UserModule Pod    ProductModule Pod
         â†“                  â†“
  å¯ä½¿ç”¨å¯¹æ–¹åè®®      å¯ä½¿ç”¨å¯¹æ–¹åè®®
  UserModuleProtocol â† â†’ ProductModuleProtocol
         â†“                  â†“
  ä½†ä¸ä¾èµ–å¯¹æ–¹å®ç°    ä½†ä¸ä¾èµ–å¯¹æ–¹å®ç°
  UserModule âœ— âœ— âœ— â†’ ProductModule
```

### å…³é”®ä¼˜åŠ¿

âœ… **é›¶ä¾èµ–** - ä¸¤ä¸ª Pod äº’ä¸ä¾èµ–  
âœ… **å®Œå…¨è§£è€¦** - é€šè¿‡åè®®é€šä¿¡  
âœ… **ç‹¬ç«‹å¼€å‘** - å›¢é˜Ÿå¹¶è¡Œå·¥ä½œ  
âœ… **ç‹¬ç«‹æµ‹è¯•** - å¯ Mock å¯¹æ–¹  
âœ… **ç±»å‹å®‰å…¨** - ç¼–è¯‘æ—¶æ£€æŸ¥  

### é€šä¿¡æ–¹å¼

```swift
// ProductModule è·å– UserModule
let userModule = ModuleManager.shared.module(UserModuleProtocol.self)

// UserModule è·å– ProductModule
let productModule = ModuleManager.shared.module(ProductModuleProtocol.self)
```

---

## ğŸ‰ å®ç°å®Œæˆ

### å·²åœ¨ä»£ç ä¸­å®ç°

1. âœ… **ProductModule.addToCart()** - è°ƒç”¨ UserModule æ£€æŸ¥ç™»å½•
2. âœ… **ProductModule.syncCart()** - è°ƒç”¨ UserModule è·å–ç”¨æˆ·ä¿¡æ¯
3. âœ… **UserModule.login()** - ç™»å½•åè°ƒç”¨ ProductModule åŒæ­¥è´­ç‰©è½¦
4. âœ… **UserModule.logout()** - ç™»å‡ºåè°ƒç”¨ ProductModule æ¸…ç©ºè´­ç‰©è½¦

### æŸ¥çœ‹ä»£ç 

- `ProductModule.swift` ç¬¬ 118-173 è¡Œ
- `UserModule.swift` ç¬¬ 126-159 è¡Œ

---

**æ¨¡å—é—´é€šä¿¡å·²å®Œå…¨å®ç°ï¼é€šè¿‡åè®®å±‚å®ç°å®Œå…¨è§£è€¦ï¼ğŸš€**

**ç«‹å³è¿è¡Œæµ‹è¯•ï¼šä¸»é¡µ â†’ åè®®è·¯ç”±ï¼ˆæ¨¡å—åŒ–ï¼‰ â†’ æµ‹è¯•è·¨æ¨¡å—é€šä¿¡ï¼ğŸ“±**

